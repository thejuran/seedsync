# Milestone v1.7: Sonarr Integration

**Status:** SHIPPED 2026-02-10
**Phases:** 22-25
**Total Plans:** 8

## Goal

Integrate with Sonarr to detect imported files and auto-delete local copies, with status visibility and in-app notifications. First *arr integration for automated post-download workflow.

## Phases

### Phase 22: Configuration & Settings UI

**Goal:** User can configure and test Sonarr connection in Settings.

**What it builds:**
- Config.Sonarr InnerConfig with enabled/sonarr_url/sonarr_api_key properties
- GET /server/config/sonarr/test-connection endpoint calling Sonarr /api/v3/system/status
- ISonarr frontend model with SonarrRecord
- *arr Integration accordion section in Settings page with enable toggle, URL/API Key fields, Test Connection button

**Addresses:** CONN-01, CONN-02, CONN-03

**Success criteria:**
1. User can enter Sonarr URL and API key in Settings page
2. User can enable/disable Sonarr integration via toggle in Settings
3. User can click "Test Connection" button and see success or failure message
4. Sonarr configuration persists across app restarts

**Key decisions:**
- Config.Sonarr uses Checkers.null (validation at test endpoint, not config parse)
- Backward-compatible from_dict: optional Sonarr section via `if "Sonarr" in config_dict`
- Custom card (not #optionsList template) for *arr Integration section -- Test Connection button doesn't fit standard pattern
- HTML5 fieldset disabled pattern to grey out fields when toggle is OFF
- ChangeDetectorRef.markForCheck() for OnPush change detection

**Plans:** 2 plans
- [x] 22-01: Backend Sonarr Config Section + Test Connection Endpoint
- [x] 22-02: Frontend *arr Integration Settings UI

---

### Phase 23: API Client Integration

**Goal:** Backend polls Sonarr queue and tracks imported files.

**What it builds:**
- SonarrManager class following Manager pattern (process() called from Controller loop)
- Queue polling with 60s interval, import detection via queue disappearance AND trackedDownloadState=="imported"
- ControllerPersist.imported_file_names (BoundedOrderedSet) for cross-restart tracking
- Controller integration: __check_sonarr_imports() after model update

**Addresses:** IMPRT-01, IMPRT-03

**Success criteria:**
1. Backend polls Sonarr queue API every 60 seconds when integration enabled
2. Backend detects when files disappear from Sonarr queue (import completion signal)
3. Imported filenames persist across app restarts to prevent duplicate detection
4. Import detection works for files synced by SeedSync (not all Sonarr activity)
5. Backend logs include Sonarr API polling activity and detected imports

**Key decisions:**
- SonarrManager re-reads config each process() call (hot-toggle without restart)
- Returns None from _fetch_queue() on error to prevent false positive import detection
- First poll uses None sentinel for bootstrap detection
- Case-insensitive name matching returns ORIGINAL model file name

**Plans:** 2 plans
- [x] 23-01: SonarrManager + ControllerPersist + Controller Integration
- [x] 23-02: Unit Tests for SonarrManager, Persist, and Controller

---

### Phase 24: Status Visibility & Notifications

**Goal:** User sees import status in UI and receives notifications.

**What it builds:**
- ModelFile.ImportStatus enum (NONE, IMPORTED) with full data pipeline through SSE serialization
- Frontend import_status parsing in ModelFile → ViewFile → file component
- Green "Imported" badge in file list status column
- ToastService with Subject-based ephemeral notifications
- Toast container in AppComponent with auto-dismiss and accessibility
- Import transition detection in file-list component firing toast on status change

**Addresses:** IMPRT-02, NOTIF-01, NOTIF-02

**Success criteria:**
1. Files show import status badge in file list (Imported)
2. Import events appear in log viewer with filename and timestamp
3. In-app toast notification appears when Sonarr imports a file
4. Toast notifications are non-blocking and auto-dismiss after 5 seconds

**Key decisions:**
- copy.copy() + manual _ModelFile__frozen = False for copy-on-write
- ToastService uses Subject (not BehaviorSubject) since toasts are ephemeral events
- Toast lifecycle managed in AppComponent via setTimeout, not Bootstrap JS API
- Subscribe to unfiltered ViewFileService.files so toasts fire for all imports
- First-emission skip prevents toasting files already in IMPORTED state on page load

**Plans:** 2 plans
- [x] 24-01: Backend import_status property + serialization + controller integration + frontend toast service
- [x] 24-02: Frontend import status badge display + toast notification triggering

---

### Phase 25: Auto-Delete with Safety

**Goal:** Local files auto-delete after Sonarr import with safety mechanisms.

**What it builds:**
- Config.AutoDelete InnerConfig with enabled/dry_run/delay_seconds
- Frontend IAutoDelete model and "Auto-Delete After Import" settings section
- Controller.__schedule_auto_delete with threading.Timer (daemon=True)
- Controller.__execute_auto_delete with 6-layer safety system
- Exit cleanup cancelling all pending timers
- 16 unit tests covering scheduling, execution, safety, and shutdown

**Addresses:** DEL-01, DEL-02, DEL-03, SAFE-01

**Success criteria:**
1. User can enable/disable auto-delete via toggle in Settings
2. Local files are automatically deleted 60 seconds after import detection (configurable delay)
3. Auto-delete only removes local copy, never touches remote seedbox files
4. Dry-run mode logs what would be deleted without actually deleting
5. Auto-delete only triggers for files that were actually imported

**Key decisions:**
- threading.Timer with daemon=True prevents timers from blocking process exit
- Config re-checked at execution time for hot-toggle support
- Pending dict uses pop() for atomic remove-and-return
- BaseControllerTestCase defaults autodelete.enabled=False to prevent MagicMock Timer issues

**Plans:** 2 plans
- [x] 25-01: Config.AutoDelete backend + frontend settings UI
- [x] 25-02: Controller auto-delete logic + unit tests

---

## Phase Dependencies

```
Phase 22 (Config & Settings) → Phase 23 (API Client)
Phase 23 (API Client) → Phase 24 (Status & Notifications)
Phase 24 (Status & Notifications) → Phase 25 (Auto-Delete)
```

## Safety Architecture

Auto-delete has 6 layers of safety:
1. **Local-only deletion:** `delete_local()` ONLY — never `delete_remote()`
2. **Dry-run mode:** Logs without deleting when enabled
3. **Hot-toggle:** Re-checks `config.autodelete.enabled` at execution time
4. **Missing file handling:** Catches `ModelError` if file removed from model
5. **Clean shutdown:** `exit()` cancels all pending timers
6. **Daemon threads:** All timers `daemon=True`, won't block process exit

## Milestone Summary

**Test Coverage Added:**
- SonarrManager: 15 unit tests
- ControllerPersist: +4 tests (imported_file_names)
- Controller: +3 integration tests + 16 auto-delete tests
- Angular: 378 passing (3 pre-existing failures unrelated)
- UAT: 9 manual tests passed (6 Phase 22, 3 Phase 23)

**Issues Resolved:**
- Enable toggle bug (Phase 22 UAT): from_dict() left sonarr.enabled=None for existing configs
- Toast spam bug: repeated toast notifications on every poll cycle (fixed with transition detection)

**Issues Deferred:**
- Radarr support (nearly identical API, planned for future milestone)
- WAITING_FOR_IMPORT enum value (deferred per research recommendation)

**Technical Debt Incurred:**
- 3 pre-existing test failures in model-file.service.spec.ts (unrelated to v1.7)
- Bootstrap 5.3 still uses @import internally (blocked until Bootstrap 6)
- Docker tests fail on arm64 (Apple Silicon) — rar package only available for amd64

---
*Created: 2026-02-10*
*Shipped: 2026-02-10*
*Milestone: v1.7 Sonarr Integration*
