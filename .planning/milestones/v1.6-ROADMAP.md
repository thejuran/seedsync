# Milestone v1.6: CI Cleanup

**Status:** SHIPPED 2026-02-10
**Phases:** 20-21
**Total Plans:** 2

## Goal

Clean up CI infrastructure by consolidating duplicate Docker workflows and silencing test runner warnings. One workflow handles all Docker publishing (dev builds + releases), and test output shows only meaningful information.

## Phases

### Phase 20: CI Workflow Consolidation

**Goal:** Single CI workflow handles all Docker publishing - `:dev` on every master push, version tags on releases.

**What it builds:**
- `:dev` image publishing job in master.yml (runs after e2e tests pass on master push)
- Multi-arch support for :dev builds (amd64 + arm64)
- docker-publish.yml workflow removed
- Version tag publishing continues working (`:X.Y.Z`, `:latest` on tag pushes)

**Addresses:** WKFL-01, WKFL-02, WKFL-03

**Success criteria:**
1. Developer merges PR to master, CI publishes `ghcr.io/thejuran/seedsync:dev` (both amd64 and arm64)
2. Developer tags `vX.Y.Z`, CI publishes `ghcr.io/thejuran/seedsync:X.Y.Z` and `:latest` (both architectures)
3. Only one workflow file exists in `.github/workflows/` for Docker publishing
4. All Docker publishing happens in `master.yml` (no separate docker-publish.yml)

**Key constraints:**
- :dev publishing only occurs on master push (not PRs, not tags)
- :dev publishing only runs after e2e tests pass
- Version tag publishing behavior unchanged from current
- Multi-arch builds use buildx with platform list (no QEMU emulation for native arm64)

**Files modified:**
- `.github/workflows/master.yml` (add :dev publishing job)
- `.github/workflows/docker-publish.yml` (delete)

**Plans:** 1 plan
- [x] 20-01-PLAN.md -- Consolidate Docker workflows, add :dev publishing to master.yml, remove docker-publish.yml

---

### Phase 21: Test Runner Cleanup

**Goal:** Test runner output shows only meaningful warnings - pytest cache and webob deprecation noise eliminated.

**What it builds:**
- pytest cache warnings suppressed in Docker test runner
- webob cgi deprecation warnings filtered from output

**Addresses:** WARN-01, WARN-02

**Success criteria:**
1. Developer runs `make run-tests-python`, sees zero pytest cache warnings
2. Developer runs `make run-tests-python`, sees zero webob cgi deprecation warnings
3. Test output shows only test results and meaningful failures
4. All 952 tests continue passing with identical behavior

**Key constraints:**
- Warnings suppressed via pytest configuration (not ignored globally)
- webob warnings filtered via pytest filterwarnings mechanism
- Zero impact on test behavior or coverage
- Changes localized to pyproject.toml pytest config

**Files modified:**
- `src/python/pyproject.toml` (pytest filterwarnings)

**Plans:** 1 plan
- [x] 21-01-PLAN.md -- Suppress pytest cache warnings and filter webob deprecation warnings

---

## Phase Dependencies

```
Phase 20 (CI consolidation) - standalone
Phase 21 (test cleanup) - standalone
```

Phases can run in any order or parallel.

## Success Criteria

1. `git push origin master` triggers :dev image publish (multi-arch) after e2e tests pass
2. `git tag vX.Y.Z && git push --tags` triggers version tag publish (multi-arch)
3. Only `master.yml` exists (docker-publish.yml deleted)
4. `make run-tests-python` shows clean output (no cache or webob warnings)
5. All 952 tests pass with no behavioral changes
6. Zero regressions in CI/CD pipeline behavior

## Milestone Summary

**Key Decisions:**

- Consolidate into master.yml rather than creating a new shared workflow (Rationale: Simpler, keeps all CI in one file)
- Use pytest `cache_dir` redirect instead of `-p no:cacheprovider` (Rationale: Preserves cache benefits while fixing permission warnings)
- Use pytest `filterwarnings` instead of suppressing at Python level (Rationale: Targeted, pytest-native, documented in config)

**Issues Resolved:**

- Duplicate Docker workflow (docker-publish.yml) bypassed test gating
- pytest cache warnings cluttering Docker test output
- webob cgi deprecation warnings from Python 3.11+ PEP 594

**Issues Deferred:**

- None

**Technical Debt Incurred:**

- `make run-tests-python` Docker build broken on arm64 (Apple Silicon) due to `rar` package only available for amd64 (pre-existing, unrelated)

---
*Created: 2026-02-09*
*Shipped: 2026-02-10*
*Milestone: v1.6 CI Cleanup*
