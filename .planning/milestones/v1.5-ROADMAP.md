# v1.5 Roadmap: Backend Testing

## Goal

Comprehensive Python backend testing: fill coverage gaps, add coverage tooling, improve test quality with shared fixtures. Bring all modules to unit-test coverage and establish a measurable baseline.

## Phases

### Phase 15: Coverage Tooling & Shared Fixtures

**Goal:** Add pytest-cov, create conftest.py with shared fixtures, establish baseline measurement.

**What it builds:**
- pytest-cov dependency in pyproject.toml with coverage config
- Root conftest.py with shared logger fixture and common mock factories
- Baseline coverage measurement (before adding new tests)
- Make target for local coverage reporting

**Addresses:** REQ-01, REQ-02, REQ-08, REQ-11

**Key constraints:**
- Must not break existing 711 tests
- Coverage config in pyproject.toml (not separate .coveragerc)
- Shared fixtures must be optional (existing tests don't need to change)

**Files modified:**
- `src/python/pyproject.toml`
- `src/python/tests/conftest.py` (new)
- `Makefile`

**Plans:** 1 plan
- [x] 15-01-PLAN.md -- pytest-cov dependency, coverage config, conftest.py fixtures, Makefile target

---

### Phase 16: Common Module Tests

**Goal:** Unit tests for all 5 untested common module files (constants, context, error, localization, types).

**What it builds:**
- `test_constants.py` -- constant values and immutability
- `test_context.py` -- Args, Context initialization, child context creation
- `test_error.py` -- exception hierarchy, inheritance chain
- `test_localization.py` -- string existence, format placeholders
- `test_types.py` -- @overrides decorator validation (positive and negative cases)

**Addresses:** REQ-03

**Key constraints:**
- Follow existing unittest.TestCase pattern
- Use conftest.py fixtures from Phase 15 where applicable
- Minimal mocking needed (mostly pure unit tests)

**Files modified:**
- `src/python/tests/unittests/test_common/test_constants.py` (new)
- `src/python/tests/unittests/test_common/test_context.py` (new)
- `src/python/tests/unittests/test_common/test_error.py` (new)
- `src/python/tests/unittests/test_common/test_localization.py` (new)
- `src/python/tests/unittests/test_common/test_types.py` (new)

**Plans:** 1 plan
- [x] 16-01-PLAN.md -- Unit tests for all 5 common modules (constants, context, error, localization, types)

---

### Phase 17: Web Handler Unit Tests

**Goal:** Unit tests for all 7 untested web handlers, isolated from integration tests.

**What it builds:**
- `test_auto_queue_handler.py` -- GET/ADD/REMOVE paths, error codes, URL decoding
- `test_config_handler.py` -- GET/SET paths, missing section/key, ConfigError
- `test_server_handler.py` -- restart flag lifecycle, thread safety
- `test_status_handler.py` -- GET status serialization
- `test_stream_heartbeat.py` -- interval timing, SSE format (CRITICAL: completely untested)
- `test_stream_model_handler.py` -- listener events, initial file delivery, real-time updates
- `test_stream_status_handler.py` -- initial status, listener queuing, cleanup

**Addresses:** REQ-06

**Key constraints:**
- Mock dependencies (controller, config, status, persist) -- not integration tests
- Test handler methods directly, not through TestApp
- Time-dependent tests (heartbeat) must mock time.time()
- Follow patterns from existing test_controller_handler.py

**Files modified:**
- `src/python/tests/unittests/test_web/test_handler/test_auto_queue_handler.py` (new)
- `src/python/tests/unittests/test_web/test_handler/test_config_handler.py` (new)
- `src/python/tests/unittests/test_web/test_handler/test_server_handler.py` (new)
- `src/python/tests/unittests/test_web/test_handler/test_status_handler.py` (new)
- `src/python/tests/unittests/test_web/test_handler/test_stream_heartbeat.py` (new)
- `src/python/tests/unittests/test_web/test_handler/test_stream_model_handler.py` (new)
- `src/python/tests/unittests/test_web/test_handler/test_stream_status_handler.py` (new)

**Plans:** 2 plans
- [ ] 17-01-PLAN.md -- Request/response handler tests (AutoQueue, Config, Server, Status)
- [ ] 17-02-PLAN.md -- Stream handler tests (Heartbeat, Model, StatusStream)

---

### Phase 18: Controller Unit Tests

**Goal:** Unit tests for controller.py (766 lines, zero unit tests) and controller_job.py.

**What it builds:**
- `test_controller_unit.py` -- initialization, command queuing, model operations, listener callbacks, error handling, memory monitoring
- `test_controller_job.py` -- Job lifecycle (setup/execute/cleanup)

**Addresses:** REQ-04, REQ-05

**Key constraints:**
- controller.py is the most complex file (766 lines, 13 private attributes)
- Must mock all managers (ScanManager, LftpManager, FileOperationManager)
- Must mock ModelBuilder, Model, Persist
- Thread safety testing requires careful mock setup
- Command callback mechanism is the critical path

**Files modified:**
- `src/python/tests/unittests/test_controller/test_controller_unit.py` (new)
- `src/python/tests/unittests/test_controller/test_controller_job.py` (new)

**Estimated plans:** 2 (initialization + commands, model operations + error handling)

---

### Phase 19: Coverage Baseline & Validation

**Goal:** Measure final coverage, set threshold, validate all tests pass.

**What it builds:**
- Final coverage measurement with all new tests
- Coverage threshold in pytest config
- Validation report: all requirements met

**Addresses:** REQ-02, REQ-07, REQ-09

**Key constraints:**
- All 711+ existing tests must still pass
- Coverage threshold set at measured baseline (not aspirational)
- Threshold should be "fail on regression" not "fail on incomplete"

**Files modified:**
- `src/python/pyproject.toml` (coverage threshold added)

**Estimated plans:** 1

---

## Phase Dependencies

```
Phase 15 (tooling + fixtures) → Phase 16 (common tests)
Phase 15 (tooling + fixtures) → Phase 17 (handler tests)
Phase 15 (tooling + fixtures) → Phase 18 (controller tests)
Phase 16, 17, 18 → Phase 19 (validation)
```

Phases 16, 17, 18 can run in parallel after Phase 15 completes.

## Success Criteria

1. `poetry run pytest` passes all tests (existing + ~350 new)
2. `poetry run pytest --cov` generates coverage report
3. Coverage baseline established and threshold enforced
4. All modules have unit test coverage
5. conftest.py reduces boilerplate in new tests
6. Zero regressions in existing test suite

---
*Created: 2026-02-08*
*Milestone: v1.5 Backend Testing*
