# Research Summary: v1.8 Radarr + Webhooks

## Radarr API Compatibility

Radarr uses identical API patterns to Sonarr:
- **Queue**: `GET /api/v3/queue` with `pageSize`, `X-Api-Key` header
- **System Status**: `GET /api/v3/system/status` — same structure, returns `version`
- **Authentication**: `X-Api-Key` header (identical to Sonarr)
- **Queue record fields**: Same `trackedDownloadState` values (downloading, importing, imported)
- **Default port**: 7878 (vs Sonarr's 8989)

## Webhook Payload Format

### Sonarr (On Import/Download)
```json
{
  "eventType": "Download",
  "instanceName": "Sonarr",
  "series": { "id": 2, "title": "Gravity Falls", "path": "/media/Gravity Falls", "tvdbId": 259972 },
  "episodes": [{ "id": 67, "episodeNumber": 14, "seasonNumber": 2, "title": "The Stanchurian Candidate" }],
  "episodeFile": { "relativePath": "Season 2/...", "path": "/media/.../file.mkv", "quality": "HDTV-720p" },
  "isUpgrade": false,
  "downloadClient": "SABnzbd",
  "downloadId": "SABnzbd_nzo_abc123"
}
```

### Radarr (On Import/Download)
```json
{
  "eventType": "Download",
  "instanceName": "Radarr",
  "movie": { "id": 1, "title": "Interstellar", "year": 2014, "folderPath": "/movies/Interstellar (2014)", "tmdbId": 157336 },
  "movieFile": { "relativePath": "Interstellar (2014) Bluray-1080p.mkv", "path": "/movies/.../file.mkv", "sceneName": "Interstellar.2014.1080p.BluRay.x264-FGT" },
  "isUpgrade": false,
  "downloadClient": "qBittorrent",
  "downloadId": "ABC123DEF456"
}
```

### Event Types
- **`Download`** — fired on import completion (both Sonarr and Radarr). UI label is "On Import".
- **`Grab`** — fired when grabbed from indexer
- **`Test`** — fired when testing webhook config. **Must return 200 OK**.

### Distinguishing Sonarr vs Radarr
- Check for `"series"` key (Sonarr) vs `"movie"` key (Radarr) in payload
- Or use separate endpoints (`/server/webhook/sonarr` vs `/server/webhook/radarr`)

### Key Fields for Import Detection
- Sonarr: `episodeFile.path` or `release.releaseTitle` (Grab) — match against model file names
- Radarr: `movieFile.sceneName` or `movie.title` — match against model file names
- Both send `eventType: "Download"` for imports (lowercase 'e' in JSON)

### Known Limitation
Radarr manual imports may not trigger webhooks (known issue). Automated imports via download client work correctly.

## Architecture: Webhook vs Polling

### Current Polling Architecture (SonarrManager)
- Polls every 60 seconds via `GET /api/v3/queue`
- Detects imports via queue disappearance + state change to "imported"
- Stateful: maintains previous queue state for diffing
- ~130 lines of polling + detection logic

### Webhook Architecture (replacement)
- POST endpoint receives JSON from Sonarr/Radarr immediately on import
- No polling overhead, zero latency
- Stateless: each webhook event is self-contained
- Thread-safe queue bridges web handler thread → controller thread
- User must configure webhook URL in Sonarr/Radarr settings

### Migration Path
1. Add POST webhook handlers (`/server/webhook/sonarr`, `/server/webhook/radarr`)
2. Create WebhookManager with thread-safe Queue
3. Controller calls WebhookManager.process() instead of SonarrManager.process()
4. Remove SonarrManager polling code
5. Display webhook URLs in Settings UI for user to copy

## Pre-existing Test Failures

3 failures in `model-file.service.spec.ts`. Need investigation during phase planning.
Tests create ModelFile objects and compare with `Immutable.is()`. Likely related to
Record field ordering or missing fields in test expectations.

## Risks

1. **Webhook reliability**: If SeedSync restarts, queued webhooks from Sonarr/Radarr are lost. Mitigation: Sonarr/Radarr retry failed webhooks.
2. **File name matching**: Webhook payload contains series/movie titles, not torrent names. Need careful matching logic.
3. **Network exposure**: Webhook endpoint must be accessible from Sonarr/Radarr. Usually same LAN, but worth noting in docs.
