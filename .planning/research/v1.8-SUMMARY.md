# Research Summary: v1.8 Radarr + Webhooks

## Radarr API Compatibility

Radarr uses identical API patterns to Sonarr:
- **Queue**: `GET /api/v3/queue` with `pageSize`, `X-Api-Key` header
- **System Status**: `GET /api/v3/system/status` — same structure, returns `version`
- **Authentication**: `X-Api-Key` header (identical to Sonarr)
- **Queue record fields**: Same `trackedDownloadState` values (downloading, importing, imported)
- **Default port**: 7878 (vs Sonarr's 8989)

## Webhook Payload Format

### Sonarr (On Import/Download)
```json
{
  "EventType": "Download",
  "Series": { "Id": 2, "Title": "Show Name", "Path": "/path/to/show", "TvdbId": 259972 },
  "Episodes": [{ "Id": 67, "EpisodeNumber": 14, "SeasonNumber": 2, "Title": "Episode Title" }]
}
```

### Radarr (On Import/Download)
Same event type `"Download"`. Key fields:
- `radarr_movie_title` — movie name
- `radarr_moviefile_path` — full path to imported file
- `radarr_moviefile_sourcepath` — original source path
- `radarr_isupgrade` — True/False

### Event Types
- **`Download`** — fired on import completion (both Sonarr and Radarr)
- **`Grab`** — fired when grabbed from indexer
- **`Test`** — fired when testing webhook config

### Key Fields for Import Detection
- Sonarr: `Series.Title` or `Episodes[].Title` — match against model file names
- Radarr: movie title or file path — match against model file names
- Both send `EventType: "Download"` for imports

## Architecture: Webhook vs Polling

### Current Polling Architecture (SonarrManager)
- Polls every 60 seconds via `GET /api/v3/queue`
- Detects imports via queue disappearance + state change to "imported"
- Stateful: maintains previous queue state for diffing
- ~130 lines of polling + detection logic

### Webhook Architecture (replacement)
- POST endpoint receives JSON from Sonarr/Radarr immediately on import
- No polling overhead, zero latency
- Stateless: each webhook event is self-contained
- Thread-safe queue bridges web handler thread → controller thread
- User must configure webhook URL in Sonarr/Radarr settings

### Migration Path
1. Add POST webhook handlers (`/server/webhook/sonarr`, `/server/webhook/radarr`)
2. Create WebhookManager with thread-safe Queue
3. Controller calls WebhookManager.process() instead of SonarrManager.process()
4. Remove SonarrManager polling code
5. Display webhook URLs in Settings UI for user to copy

## Pre-existing Test Failures

3 failures in `model-file.service.spec.ts`. Need investigation during phase planning.
Tests create ModelFile objects and compare with `Immutable.is()`. Likely related to
Record field ordering or missing fields in test expectations.

## Risks

1. **Webhook reliability**: If SeedSync restarts, queued webhooks from Sonarr/Radarr are lost. Mitigation: Sonarr/Radarr retry failed webhooks.
2. **File name matching**: Webhook payload contains series/movie titles, not torrent names. Need careful matching logic.
3. **Network exposure**: Webhook endpoint must be accessible from Sonarr/Radarr. Usually same LAN, but worth noting in docs.
