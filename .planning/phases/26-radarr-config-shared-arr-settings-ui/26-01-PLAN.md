---
phase: 26-radarr-config-shared-arr-settings-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/python/common/config.py
  - src/python/seedsync.py
  - src/python/web/handler/config.py
  - src/python/tests/unittests/test_common/test_config.py
  - src/python/tests/unittests/test_web/test_handler/test_config_handler.py
autonomous: true

must_haves:
  truths:
    - "Radarr configuration (enabled, URL, API key) persists across app restarts"
    - "Test connection endpoint calls Radarr /api/v3/system/status and returns success/failure JSON"
    - "Existing Sonarr configuration continues working unchanged"
    - "Config files without [Radarr] section load without error (backward compatibility)"
  artifacts:
    - path: "src/python/common/config.py"
      provides: "Config.Radarr InnerConfig class with enabled, radarr_url, radarr_api_key"
      contains: "class Radarr"
    - path: "src/python/web/handler/config.py"
      provides: "GET /server/config/radarr/test-connection endpoint"
      contains: "__handle_test_radarr_connection"
    - path: "src/python/seedsync.py"
      provides: "Default Radarr config values on fresh install"
      contains: "radarr"
  key_links:
    - from: "src/python/web/handler/config.py"
      to: "src/python/common/config.py"
      via: "self.__config.radarr.radarr_url"
      pattern: "self.__config\\.radarr"
    - from: "src/python/common/config.py"
      to: "Config.from_dict"
      via: "backward-compatible optional section parsing"
      pattern: "if .Radarr. in config_dict"
---

<objective>
Add Config.Radarr InnerConfig class, backward-compatible config parsing, default values, and GET /server/config/radarr/test-connection endpoint.

Purpose: Backend foundation for Radarr configuration. Mirrors the existing Sonarr implementation (Phase 22-01) exactly, with different property names and default port.
Output: Config.Radarr class, test connection endpoint, default config values, unit tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-radarr-config-shared-arr-settings-ui/26-RESEARCH.md
@.planning/phases/22-configuration-settings-ui/22-01-SUMMARY.md
@src/python/common/config.py
@src/python/web/handler/config.py
@src/python/seedsync.py
@src/python/tests/unittests/test_common/test_config.py
@src/python/tests/unittests/test_web/test_handler/test_config_handler.py
@src/python/web/serialize/serialize_config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Config.Radarr InnerConfig class with backward-compatible parsing and defaults</name>
  <files>
    src/python/common/config.py
    src/python/seedsync.py
    src/python/tests/unittests/test_common/test_config.py
  </files>
  <action>
    In src/python/common/config.py:

    1. Add Config.Radarr InnerConfig class AFTER Config.Sonarr (before Config.AutoDelete, around line 312). Mirror Sonarr exactly:
       ```python
       class Radarr(IC):
           enabled = PROP("enabled", Checkers.null, Converters.bool)
           radarr_url = PROP("radarr_url", Checkers.null, Converters.null)
           radarr_api_key = PROP("radarr_api_key", Checkers.null, Converters.null)

           def __init__(self):
               super().__init__()
               self.enabled = None
               self.radarr_url = None
               self.radarr_api_key = None
       ```

    2. In Config.__init__ (line ~324), add `self.radarr = Config.Radarr()` AFTER `self.sonarr` and BEFORE `self.autodelete`.

    3. In Config.from_dict (line ~380), add backward-compatible Radarr section parsing AFTER the Sonarr block (lines 391-398) and BEFORE the AutoDelete block (lines 400-409):
       ```python
       # Radarr section is optional for backward compatibility with older config files
       if "Radarr" in config_dict:
           config.radarr = Config.Radarr.from_dict(Config._check_section(config_dict, "Radarr"))
       else:
           # Default values for existing installs missing [Radarr] section
           config.radarr.enabled = False
           config.radarr.radarr_url = ""
           config.radarr.radarr_api_key = ""
       ```

    4. In Config.as_dict (line ~414), add `config_dict["Radarr"] = self.radarr.as_dict()` AFTER Sonarr line and BEFORE AutoDelete line.

    In src/python/seedsync.py:

    5. In _create_default_config, add after the sonarr defaults (line ~324) and before autodelete defaults:
       ```python
       config.radarr.enabled = False
       config.radarr.radarr_url = ""
       config.radarr.radarr_api_key = ""
       ```

    In src/python/tests/unittests/test_common/test_config.py:

    6. In test_has_section, add `self.assertTrue(config.has_section("radarr"))` after the sonarr assertion.

    7. In test_to_file, add radarr config setup lines after sonarr setup:
       ```python
       config.radarr.enabled = False
       config.radarr.radarr_url = "http://localhost:7878"
       config.radarr.radarr_api_key = "def456"
       ```
       And add Radarr section to the golden string AFTER the [Sonarr] section and BEFORE [AutoDelete]:
       ```
       [Radarr]
       enabled = False
       radarr_url = http://localhost:7878
       radarr_api_key = def456
       ```

    IMPORTANT: The golden string comparison in test_to_file is strict line-by-line. The section ordering MUST match as_dict() ordering: General, Lftp, Controller, Web, AutoQueue, Sonarr, Radarr, AutoDelete.

    Note: SerializeConfig.config() in serialize_config.py lowercases section names automatically via `key.lower()`, so the frontend will receive "radarr" (lowercase). No changes needed there.
  </action>
  <verify>
    Run: `cd /Users/julianamacbook/seedsync/src/python && poetry run pytest tests/unittests/test_common/test_config.py -v`
    All tests pass including test_has_section, test_to_file, and test_from_file (backward compatibility).
  </verify>
  <done>
    Config.Radarr class exists with 3 properties (enabled, radarr_url, radarr_api_key). Config.from_dict handles missing [Radarr] section gracefully. Config.as_dict includes Radarr section. Default config sets radarr.enabled=False. All config unit tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add test connection endpoint and unit tests for ConfigHandler</name>
  <files>
    src/python/web/handler/config.py
    src/python/tests/unittests/test_web/test_handler/test_config_handler.py
  </files>
  <action>
    In src/python/web/handler/config.py:

    1. In add_routes (line ~19), add after the sonarr test-connection route:
       ```python
       web_app.add_handler("/server/config/radarr/test-connection", self.__handle_test_radarr_connection)
       ```

    2. Add __handle_test_radarr_connection method after __handle_test_sonarr_connection. Mirror the Sonarr method exactly with these substitutions:
       - `self.__config.sonarr.sonarr_url` -> `self.__config.radarr.radarr_url`
       - `self.__config.sonarr.sonarr_api_key` -> `self.__config.radarr.radarr_api_key`
       - Error messages: "Sonarr" -> "Radarr" in all messages ("Radarr URL is required", "Radarr API key is required", "Radarr returned status {}", "Connection refused - check Radarr URL")
       - Same API endpoint: `/api/v3/system/status` (identical to Sonarr)
       - Same 10-second timeout, same X-Api-Key header pattern
       - Same response format: `{"success": true, "version": "..."}` or `{"success": false, "error": "..."}`

    In src/python/tests/unittests/test_web/test_handler/test_config_handler.py:

    3. Add TestConfigHandlerTestRadarrConnection class mirroring the Sonarr test connection tests. Use `unittest.mock.patch('web.handler.config.requests')` to mock HTTP calls. Tests to add:

       - test_radarr_missing_url_returns_error: Set radarr_url to "", call handler, assert response has success=False with "Radarr URL is required"
       - test_radarr_missing_api_key_returns_error: Set radarr_url to "http://localhost:7878", radarr_api_key to "", assert success=False with "Radarr API key is required"
       - test_radarr_success_returns_version: Mock requests.get to return 200 with JSON {"version": "5.0.0"}, assert success=True with version "5.0.0"
       - test_radarr_401_returns_invalid_key: Mock requests.get to return 401, assert success=False with "Invalid API key"
       - test_radarr_connection_error: Mock requests.get to raise requests.ConnectionError, assert success=False with "Connection refused"
       - test_radarr_timeout: Mock requests.get to raise requests.Timeout, assert success=False with "Connection timed out"
       - test_radarr_strips_trailing_slash: Set radarr_url to "http://localhost:7878/", mock requests.get, verify the URL passed to requests.get is "http://localhost:7878/api/v3/system/status" (no double slash)

       Each test should create a Config() instance, set radarr properties directly, create ConfigHandler(config), and call the private method via `handler._ConfigHandler__handle_test_radarr_connection()`.

       Follow the existing test pattern in the file: setUp creates mock_config and handler, tests access private methods via name mangling.

       For the radarr tests, use a real Config object (not MagicMock) since the handler reads nested properties (config.radarr.radarr_url). Set the config properties:
       ```python
       config = Config()
       config.radarr.radarr_url = "http://localhost:7878"
       config.radarr.radarr_api_key = "testapikey123"
       handler = ConfigHandler(config)
       ```
  </action>
  <verify>
    Run: `cd /Users/julianamacbook/seedsync/src/python && poetry run pytest tests/unittests/test_web/test_handler/test_config_handler.py -v`
    All existing config handler tests still pass. All 7 new Radarr test connection tests pass.
  </verify>
  <done>
    GET /server/config/radarr/test-connection route registered. Handler validates URL and API key, calls Radarr /api/v3/system/status, returns JSON with success/failure. 7 unit tests cover happy path, validation errors, HTTP errors, and URL normalization. All tests pass.
  </done>
</task>

</tasks>

<verification>
1. All Python unit tests pass: `cd /Users/julianamacbook/seedsync/src/python && poetry run pytest tests/unittests/ -v`
2. Config.Radarr class has 3 properties: enabled, radarr_url, radarr_api_key
3. Config files without [Radarr] section parse without error (backward compatibility)
4. Config.as_dict includes Radarr section
5. /server/config/radarr/test-connection endpoint exists and returns proper JSON responses
6. Sonarr configuration and test connection still work unchanged
</verification>

<success_criteria>
- Config.Radarr InnerConfig class exists with enabled (bool), radarr_url (str), radarr_api_key (str)
- Backward-compatible config parsing: old configs without [Radarr] default to disabled
- Default config (fresh install) has radarr.enabled=False
- GET /server/config/radarr/test-connection returns JSON success/failure
- All Python unit tests pass (config + config handler)
- No changes to existing Sonarr functionality
</success_criteria>

<output>
After completion, create `.planning/phases/26-radarr-config-shared-arr-settings-ui/26-01-SUMMARY.md`
</output>
