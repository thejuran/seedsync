---
phase: 07-seasonal-cost-heatmap
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/src/lib/utils.ts
  - frontend/src/components/PointChartTable.tsx
  - frontend/src/components/CostHeatmap.tsx
  - frontend/src/pages/PointChartsPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can view a full-year calendar heatmap where each day is color-coded by point cost tier (HEAT-01)"
    - "User can switch between resorts and room types to compare cost patterns (HEAT-02)"
    - "User can distinguish weekday vs weekend cost differences visually (HEAT-03)"
    - "User can hover over any day to see date, season name, point cost, and weekday/weekend (HEAT-04)"
  artifacts:
    - path: "frontend/src/lib/utils.ts"
      provides: "Shared heatColor() function"
      contains: "heatColor"
    - path: "frontend/src/components/CostHeatmap.tsx"
      provides: "Full-year calendar heatmap component with room selector, tooltip, color legend"
      min_lines: 150
    - path: "frontend/src/pages/PointChartsPage.tsx"
      provides: "4th tab 'Cost Heatmap' wired to CostHeatmap component"
      contains: "heatmap"
  key_links:
    - from: "frontend/src/pages/PointChartsPage.tsx"
      to: "frontend/src/components/CostHeatmap.tsx"
      via: "import and render in heatmap tab"
      pattern: "import CostHeatmap"
    - from: "frontend/src/components/CostHeatmap.tsx"
      to: "frontend/src/lib/utils.ts"
      via: "import heatColor for cell coloring"
      pattern: "import.*heatColor.*from.*utils"
    - from: "frontend/src/components/CostHeatmap.tsx"
      to: "PointChart data from usePointChart hook"
      via: "props passed from PointChartsPage (chart + rooms)"
      pattern: "chart\\.seasons"
    - from: "frontend/src/components/PointChartTable.tsx"
      to: "frontend/src/lib/utils.ts"
      via: "import shared heatColor instead of local definition"
      pattern: "import.*heatColor.*from.*utils"
---

<objective>
Build a seasonal cost heatmap that displays a full-year calendar with each day color-coded by point cost, integrated as a 4th tab on the existing Point Charts page.

Purpose: Users need to visually compare point costs across an entire year for any resort and room type, enabling quick identification of cheap vs expensive travel windows.

Output: CostHeatmap component with room selector, 12-month grid, cost-based coloring, weekend indicators, hover tooltips, and color legend -- all wired into the Point Charts page as a new "Cost Heatmap" tab.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/07-seasonal-cost-heatmap/07-RESEARCH.md

Key source files to read before implementing:
@frontend/src/components/SeasonCalendar.tsx -- MonthGrid pattern (grid layout, day alignment, weekend detection, tooltip)
@frontend/src/components/PointChartTable.tsx -- heatColor() function to extract
@frontend/src/components/StayCostCalculator.tsx -- Room selector pattern (Select with room.key/room_type/view)
@frontend/src/pages/PointChartsPage.tsx -- Tab system to extend, data hooks already connected
@frontend/src/types/index.ts -- PointChart, Season, RoomInfo interfaces
@frontend/src/hooks/usePointCharts.ts -- usePointChart, useChartRooms hooks
@frontend/src/lib/utils.ts -- cn() utility, target for heatColor extraction
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract heatColor to shared utils and build CostHeatmap component</name>
  <files>
    frontend/src/lib/utils.ts
    frontend/src/components/PointChartTable.tsx
    frontend/src/components/CostHeatmap.tsx
  </files>
  <action>
**Step 1: Extract heatColor() to shared utils**

Move the `heatColor()` function from `PointChartTable.tsx` (lines 17-25) into `frontend/src/lib/utils.ts` as a named export. The function signature is:

```typescript
export function heatColor(value: number, min: number, max: number): string
```

Keep the exact same implementation (5-tier green-to-red with dark mode variants). Then update `PointChartTable.tsx` to import `heatColor` from `@/lib/utils` instead of defining it locally. Remove the local function definition from PointChartTable.tsx.

**Step 2: Create CostHeatmap component**

Create `frontend/src/components/CostHeatmap.tsx` with the following structure. This component is modeled directly on `SeasonCalendar.tsx` for the grid layout and `StayCostCalculator.tsx` for the room selector.

**Props interface:**
```typescript
interface CostHeatmapProps {
  chart: PointChart;
  rooms: RoomInfo[];
}
```

These are the same types already used by PointChartTable and StayCostCalculator. Import from `../types`.

**DayCost interface (local to this file):**
```typescript
interface DayCost {
  date: string;       // "2026-01-15"
  day: number;        // 15
  points: number;     // e.g. 14
  season: string;     // "Adventure"
  isWeekend: boolean; // true for Fri(5) and Sat(6) per DVC definition
}
```

**Component state:**
- `roomKey` (string) -- selected room key, default to empty string, auto-select first room via useEffect when `rooms` prop changes (same pattern as StayCostCalculator)
- `tooltip` (object or null) -- `{ x: number; y: number; data: DayCost } | null`, for hover tooltip positioning

**CRITICAL: Room key auto-reset.** When `rooms` changes (because user switched resort on PointChartsPage), reset `roomKey` to the first available room. This prevents the pitfall of stale room keys across resort switches. Use a `useEffect` watching `rooms`:

```typescript
useEffect(() => {
  if (rooms.length > 0) {
    setRoomKey(rooms[0].key);
  } else {
    setRoomKey("");
  }
}, [rooms]);
```

**Daily cost computation (useMemo):**

Build a `dailyCosts: DayCost[]` array via `useMemo` with deps `[chart, roomKey]`. Algorithm:

1. Build a date-to-season lookup map from `chart.seasons`. For each season, iterate its `date_ranges` (array of `[startStr, endStr]` tuples). For each range, walk day-by-day from start to end inclusive. Use `new Date(dateStr + "T00:00:00")` to avoid timezone shifting (matches SeasonCalendar pattern). The map key is the date string `YYYY-MM-DD`, and the value is the season object `{ name, rooms }`.

2. Walk every day of `chart.year` from Jan 1 to Dec 31. For each day:
   - Compute `dateStr` as `YYYY-MM-DD`
   - Look up season from the map
   - Determine `isWeekend` using `getDay()`: DVC weekend = Friday (5) or Saturday (6). NOT Saturday/Sunday.
   - Look up `season.rooms[roomKey]` to get `{ weekday, weekend }` costs
   - Push `{ date: dateStr, day, points, season: seasonName, isWeekend }` into result
   - If room data not found for this season/room combo, set points to 0

Return early with empty array if `!roomKey`.

**Min/max computation (useMemo):**

Compute `{ min, max }` from `dailyCosts` filtering where `points > 0`, with deps `[dailyCosts]`. If no valid points, default both to 0.

**Room selector (at the top):**

Use the shadcn `Select` component exactly as in StayCostCalculator (lines 122-135). Label "Room Type". Display `{room.room_type} - {room.view}` for each option. Full width within a constrained container (e.g., `max-w-sm`).

**12-month grid:**

Use the exact same grid layout as SeasonCalendar:
```
<div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
```

Create a `HeatmapMonthGrid` sub-component (can be in the same file, like SeasonCalendar's `MonthGrid`). Props: `year`, `month`, `monthName`, `dailyCosts` (filtered to this month), `min`, `max`, `onHover` callback, `onLeave` callback.

Inside HeatmapMonthGrid:
- Same day-of-week headers as SeasonCalendar: `["S", "M", "T", "W", "T", "F", "S"]`
- Same padding logic: `startDow` empty cells before day 1, pad end to fill last row
- Each day cell: `h-7` height, `text-xs`, `rounded`, shows the day number
- Cell background: `heatColor(dayCost.points, min, max)` from the shared utils import. For days with `points === 0`, use no color (just `text-muted-foreground`)
- Weekend indicator: Same dot as SeasonCalendar -- `<span className="absolute bottom-0.5 left-1/2 -translate-x-1/2 w-1 h-1 rounded-full bg-foreground/60" />` when `isWeekend` is true
- Hover: `onMouseEnter` calls parent's `onHover` with `{ x: e.clientX, y: e.clientY, data: dayCost }`. `onMouseLeave` calls `onLeave`.
- Cell needs `relative` class for the weekend dot positioning (same as SeasonCalendar)

**Tooltip:**

Render a fixed-position tooltip when `tooltip !== null`:
```tsx
{tooltip && (
  <div
    className="fixed z-50 bg-popover text-popover-foreground border rounded-lg shadow-lg px-3 py-2 text-sm pointer-events-none"
    style={{ left: tooltip.x + 12, top: tooltip.y + 12 }}
  >
    <div className="font-semibold">{format(parseISO(tooltip.data.date), "EEEE, MMM d, yyyy")}</div>
    <div className="text-muted-foreground">Season: {tooltip.data.season}</div>
    <div>
      <span className="font-medium">{tooltip.data.points} points</span>
      <span className="text-muted-foreground ml-1">({tooltip.data.isWeekend ? "Weekend" : "Weekday"})</span>
    </div>
  </div>
)}
```

Import `format` and `parseISO` from `date-fns` (already used in 4 other components).

**Color legend (below the grid):**

5-tier legend matching heatColor thresholds:
```typescript
const COST_TIERS = [
  { label: "Low", className: "bg-green-400" },
  { label: "Below Avg", className: "bg-lime-400" },
  { label: "Average", className: "bg-yellow-400" },
  { label: "Above Avg", className: "bg-orange-400" },
  { label: "High", className: "bg-red-400" },
];
```

Render as a flex row of colored squares (w-4 h-4 rounded) with labels, centered. Same layout pattern as SeasonCalendar's legend (line 84-94). Also include the weekend dot legend below (same as SeasonCalendar line 96-101).

**Empty state:** If no `roomKey` selected (shouldn't happen with auto-select, but defensive), show a message "Select a room type to view the cost heatmap."

**Imports needed:**
- `{ useState, useMemo, useEffect }` from "react"
- `{ format, parseISO }` from "date-fns"
- `{ Select, SelectContent, SelectItem, SelectTrigger, SelectValue }` from "@/components/ui/select"
- `{ heatColor }` from "@/lib/utils"
- `type { PointChart, RoomInfo }` from "../types"
  </action>
  <verify>
1. `cd /Users/julianamacbook/dvc/frontend && npx tsc --noEmit` -- TypeScript compiles without errors
2. Confirm `heatColor` is exported from utils.ts and imported (not defined locally) in both PointChartTable.tsx and CostHeatmap.tsx
3. Confirm CostHeatmap.tsx exists with all required sections: room selector, month grid, tooltip, legend
  </verify>
  <done>
- heatColor() is a shared export in lib/utils.ts, imported by both PointChartTable and CostHeatmap
- CostHeatmap component accepts chart + rooms props, renders room selector, 12-month heatmap grid, hover tooltip, and color legend
- Weekend (Fri/Sat) days have dot indicators
- Room key auto-resets when rooms prop changes
- Daily costs computed client-side via useMemo from chart data
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Cost Heatmap tab to PointChartsPage</name>
  <files>
    frontend/src/pages/PointChartsPage.tsx
  </files>
  <action>
**Modify `frontend/src/pages/PointChartsPage.tsx` to add the Cost Heatmap as a 4th tab.**

**Step 1: Add import**

Add at the top with the other component imports:
```typescript
import CostHeatmap from "../components/CostHeatmap";
```

**Step 2: Extend TabId type and TABS array**

Change line 20:
```typescript
type TabId = "chart" | "calendar" | "calculator" | "heatmap";
```

Add to the TABS array (after "calculator"):
```typescript
{ id: "heatmap", label: "Cost Heatmap" },
```

**Step 3: Add tab content rendering**

After the calculator tab content block (after line 188), add:
```typescript
{activeTab === "heatmap" && chart && roomsData && (
  <CostHeatmap chart={chart} rooms={roomsData.rooms} />
)}
```

This follows the exact same pattern as the other tab content blocks. The `chart` data comes from `usePointChart()` (already fetched) and `roomsData.rooms` comes from `useChartRooms()` (already fetched). No new hooks or API calls needed.

**That's it.** The PointChartsPage already handles resort/year selection and data fetching. The CostHeatmap component handles room selection internally (following the StayCostCalculator pattern). When the user switches resort or year at the page level, new chart/rooms data flows into CostHeatmap via props, and the useEffect in CostHeatmap auto-resets the room selection.
  </action>
  <verify>
1. `cd /Users/julianamacbook/dvc/frontend && npx tsc --noEmit` -- TypeScript compiles without errors
2. `cd /Users/julianamacbook/dvc/frontend && npm run build` -- Production build succeeds
3. Run the app (`cd /Users/julianamacbook/dvc && docker compose up --build -d` or `cd /Users/julianamacbook/dvc/frontend && npm run dev`) and verify:
   - Navigate to Point Charts page
   - 4th tab "Cost Heatmap" is visible
   - Clicking it shows the heatmap with a room selector and 12-month calendar grid
   - Days are color-coded green (low cost) to red (high cost)
   - Weekend days (Fri/Sat) have small dot indicators
   - Hovering over a day shows tooltip with date, season, points, and weekday/weekend
   - Switching room type updates the heatmap colors
   - Switching resort (page-level selector) resets room selection and shows new heatmap
   - Color legend shows 5 tiers below the calendar
  </verify>
  <done>
- PointChartsPage has 4 tabs: Point Chart, Season Calendar, Cost Calculator, Cost Heatmap
- Cost Heatmap tab renders CostHeatmap component with chart and rooms props
- All HEAT requirements satisfied:
  - HEAT-01: Full-year calendar with cost-based color coding
  - HEAT-02: Resort switching via page selector, room switching via component selector
  - HEAT-03: Weekend (Fri/Sat) distinguished with dot indicator, cost difference visible via color
  - HEAT-04: Hover tooltip shows date, season name, point cost, weekday/weekend
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd /Users/julianamacbook/dvc/frontend && npx tsc --noEmit` passes
2. Production build: `cd /Users/julianamacbook/dvc/frontend && npm run build` succeeds
3. Functional verification:
   - Point Charts page shows 4 tabs (the 4th is "Cost Heatmap")
   - Selecting "Cost Heatmap" tab shows a room type dropdown and a 12-month calendar grid
   - Each day cell is color-coded from green (cheapest) to red (most expensive) based on point cost for the selected room
   - Friday and Saturday cells have a small dot indicator (DVC weekend)
   - Hovering any day shows a tooltip with: full date, season name, point cost, and "Weekend" or "Weekday"
   - Changing room type immediately updates all cell colors (no loading spinner, client-side computation)
   - Changing resort at page level resets the room selector to the first available room and recomputes the heatmap
   - A 5-tier color legend appears below the calendar grid
   - Dark mode colors are readable (using existing dark: variants from heatColor)
4. No regressions: Existing Point Chart, Season Calendar, and Cost Calculator tabs still work correctly
5. PointChartTable still renders correctly (heatColor extraction didn't break it)
</verification>

<success_criteria>
- User can view a full-year calendar heatmap where each day is color-coded by point cost tier
- User can switch between resorts (page selector) and room types (component selector) to compare cost patterns
- User can distinguish weekday vs weekend costs visually via dot indicators and see the difference in hover tooltip
- User can hover over any day to see the date, season name, point cost, and whether it's a weekday or weekend
- No new backend endpoint or external dependency added
- TypeScript compiles cleanly, production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/07-seasonal-cost-heatmap/07-01-SUMMARY.md`
</output>
