---
phase: 19-coverage-baseline-validation
plan: 01
type: execute
wave: 1
depends_on: ["15-01", "16-01", "17-01", "17-02", "18-01", "18-02"]
files_modified:
  - src/python/pyproject.toml
autonomous: true

must_haves:
  truths:
    - "poetry run pytest passes all 952 tests (existing + new from phases 15-18) with zero new regressions"
    - "poetry run pytest --cov produces a coverage report showing overall coverage percentage"
    - "pyproject.toml has a [tool.coverage.report] fail_under threshold set at or below the measured coverage"
    - "poetry run pytest --cov exits 0 (threshold not violated) confirming the fail_under value is correct"
    - "The threshold is based on measured coverage, not aspirational — it prevents regression, not incomplete coverage"
    - "make coverage-python still works end-to-end and produces terminal + HTML reports"
  artifacts:
    - path: "src/python/pyproject.toml"
      provides: "Coverage fail_under threshold in [tool.coverage.report] section"
      contains: "fail_under"
  key_links:
    - from: "src/python/pyproject.toml [tool.coverage.report]"
      to: "poetry run pytest --cov exit code"
      via: "coverage fail_under causes non-zero exit when coverage drops below threshold"
      pattern: "fail_under"
    - from: "Makefile coverage-python"
      to: "src/python/ pytest --cov invocation"
      via: "cd to src/python and run poetry run pytest --cov"
      pattern: "poetry run pytest --cov"
---

<objective>
Measure final coverage after all v1.5 test phases (15-18) are complete, set a fail_under threshold in pyproject.toml to prevent regression, and validate the entire test suite passes with the threshold active.

Purpose: This is the capstone phase of v1.5 Backend Testing. It locks in the coverage gains from phases 15-18 by establishing an enforced baseline. Future changes that reduce coverage will cause pytest --cov to fail, protecting the investment made in phases 16-18.

Output: Updated pyproject.toml with fail_under threshold, final coverage numbers recorded in SUMMARY.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/milestones/v1.5-ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/15-coverage-tooling-shared-fixtures/15-01-SUMMARY.md
@src/python/pyproject.toml
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Measure final coverage and set fail_under threshold</name>
  <files>src/python/pyproject.toml</files>
  <action>
  1. Run the full test suite with coverage from src/python/:
     `poetry run pytest --cov --cov-report=term -q 2>&1 | tail -5`

     Record the TOTAL coverage percentage from the output. This is the final
     coverage after all v1.5 phases (15-18) have added tests.

  2. Determine the fail_under threshold:
     - Take the measured coverage percentage (e.g., if 84%, use 84)
     - Round DOWN to the nearest whole number
     - This prevents regression while allowing minor fluctuations

  3. Add `fail_under` to the existing `[tool.coverage.report]` section in
     src/python/pyproject.toml. The section currently looks like:

     ```toml
     [tool.coverage.report]
     show_missing = true
     skip_empty = true
     exclude_lines = [
         "pragma: no cover",
         "if __name__ == .__main__.",
         "pass",
     ]
     ```

     Add `fail_under = <threshold>` as the FIRST line in that section:

     ```toml
     [tool.coverage.report]
     fail_under = 84
     show_missing = true
     skip_empty = true
     exclude_lines = [
         "pragma: no cover",
         "if __name__ == .__main__.",
         "pass",
     ]
     ```

     Use the actual measured value (rounded down), not the example 84.

  4. Do NOT change any other configuration. Do NOT add --cov to addopts.
     Coverage measurement remains opt-in (via explicit --cov flag or Makefile target).
  </action>
  <verify>
  1. Run coverage with threshold active:
     `cd src/python && poetry run pytest --cov -q 2>&1 | tail -10`
     Expected: Tests pass AND no "FAIL Required test coverage" message.
     The exit code should be 0 (coverage meets or exceeds threshold).

  2. Verify fail_under is in pyproject.toml:
     `grep fail_under src/python/pyproject.toml`
     Expected: `fail_under = <threshold>`

  3. Verify make target still works:
     `make coverage-python 2>&1 | tail -5`
     Expected: Exits 0, shows coverage summary.

  4. Verify plain pytest (without --cov) is unaffected:
     `cd src/python && poetry run pytest -q 2>&1 | tail -3`
     Expected: Same test results as before — fail_under only activates with --cov.

  5. Record final numbers for the SUMMARY:
     - Total tests collected
     - Tests passed / failed / errors / skipped
     - TOTAL coverage percentage (statements, missed, branches, branch-misses)
     - fail_under threshold value
  </verify>
  <done>
  - pyproject.toml [tool.coverage.report] has fail_under = <threshold>
  - poetry run pytest --cov exits 0 (threshold met)
  - make coverage-python exits 0
  - Plain pytest (no --cov) is unaffected by the threshold
  - Final coverage numbers recorded
  </done>
</task>

</tasks>

<verification>
Phase-level verification after task completes:

1. **All tests pass:** `cd src/python && poetry run pytest -q` shows 952 passed (with expected env-dependent failures/errors)
2. **Coverage threshold active:** `cd src/python && poetry run pytest --cov -q 2>&1 | grep -E "TOTAL|FAIL"` shows coverage above threshold, no FAIL message
3. **Threshold enforced:** Temporarily verify threshold works by checking that fail_under is set (do NOT actually lower coverage to test — that would require reverting)
4. **Make target works:** `make coverage-python` exits 0
5. **No functional changes:** Only pyproject.toml modified, no production code or test code changes
6. **Coverage opt-in preserved:** `poetry run pytest -q` (no --cov) does not report coverage and is unaffected by fail_under
</verification>

<success_criteria>
- pyproject.toml has fail_under = <measured_baseline> in [tool.coverage.report]
- fail_under is set at measured value (rounded down), not aspirational
- poetry run pytest --cov exits 0 (threshold met)
- make coverage-python exits 0
- Plain pytest (no --cov) is unaffected
- All existing + new tests pass (952 total, with env-dependent failures expected locally)
- No production code changes, no test code changes — config only
</success_criteria>

<output>
After completion, create `.planning/phases/19-coverage-baseline-validation/19-01-SUMMARY.md`

The SUMMARY must include:
- Final coverage percentage and threshold value
- Comparison to Phase 15 baseline (77% → final%)
- Total tests: collected, passed, failed, errors, skipped
- New tests added in v1.5 (952 - 711 = 241 new tests)
- Exact pyproject.toml change (fail_under line added)
- Requirements addressed: REQ-02, REQ-07, REQ-09
- Confirmation that all v1.5 success criteria from ROADMAP are met
</output>
