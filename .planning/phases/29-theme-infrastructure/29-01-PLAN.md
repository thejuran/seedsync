---
phase: 29-theme-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/angular/src/app/services/theme/theme.types.ts
  - src/angular/src/app/services/theme/theme.service.ts
  - src/angular/src/index.html
  - src/angular/src/app/app.config.ts
  - src/angular/src/styles.scss
autonomous: true

must_haves:
  truths:
    - "App applies dark or light theme based on stored preference or OS setting"
    - "User sees no flash of wrong theme when page loads"
    - "Changing theme via themeService.setTheme('dark') immediately updates the UI"
    - "Theme preference persists across page refreshes via localStorage"
    - "Opening a second tab shows same theme as the first tab"
    - "Changing theme in one tab updates all other open tabs"
    - "When set to auto, app follows OS color scheme preference"
    - "Changing OS theme while in auto mode updates the app theme"
  artifacts:
    - path: "src/angular/src/app/services/theme/theme.types.ts"
      provides: "ThemeMode type definition"
      contains: "ThemeMode"
    - path: "src/angular/src/app/services/theme/theme.service.ts"
      provides: "Signal-based theme management service"
      exports: ["ThemeService"]
      min_lines: 60
    - path: "src/angular/src/index.html"
      provides: "FOUC prevention inline script"
      contains: "data-bs-theme"
    - path: "src/angular/src/app/app.config.ts"
      provides: "ThemeService registration"
      contains: "ThemeService"
  key_links:
    - from: "src/angular/src/index.html"
      to: "localStorage"
      via: "inline script reads theme key before Angular bootstraps"
      pattern: "localStorage\\.getItem.*theme"
    - from: "src/angular/src/app/services/theme/theme.service.ts"
      to: "document.documentElement"
      via: "effect() sets data-bs-theme attribute"
      pattern: "setAttribute.*data-bs-theme"
    - from: "src/angular/src/app/services/theme/theme.service.ts"
      to: "window storage event"
      via: "addEventListener for cross-tab sync"
      pattern: "addEventListener.*storage"
    - from: "src/angular/src/app/services/theme/theme.service.ts"
      to: "window.matchMedia"
      via: "OS preference detection and change listener"
      pattern: "matchMedia.*prefers-color-scheme"
    - from: "src/angular/src/app/app.config.ts"
      to: "src/angular/src/app/services/theme/theme.service.ts"
      via: "APP_INITIALIZER ensures ThemeService is instantiated at boot"
      pattern: "ThemeService"
---

<objective>
Implement the complete theme infrastructure: ThemeService with Angular signals, FOUC prevention inline script, localStorage persistence, multi-tab synchronization, and OS preference detection.

Purpose: Enables Bootstrap 5.3 dark/light theme switching with zero flash on page load, satisfying all THEME-01 through THEME-06 requirements.
Output: Working theme system that can be exercised via browser console (`themeService.setTheme('dark')`) before the toggle UI is built in Phase 31.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-theme-infrastructure/29-RESEARCH.md
@.planning/phases/29-theme-infrastructure/CONTEXT.md
@src/angular/src/index.html
@src/angular/src/app/app.config.ts
@src/angular/src/app/services/utils/local-storage.service.ts
@src/angular/src/styles.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeService with signal-based state management</name>
  <files>
    src/angular/src/app/services/theme/theme.types.ts
    src/angular/src/app/services/theme/theme.service.ts
  </files>
  <action>
Create the theme types and service files.

**theme.types.ts:**
- Export `ThemeMode` type alias: `'light' | 'dark' | 'auto'`
- Export `ResolvedTheme` type alias: `'light' | 'dark'` (what actually gets applied to DOM)
- Export `THEME_STORAGE_KEY` constant: `'theme'`

**theme.service.ts:**
- `@Injectable({ providedIn: 'root' })` — follows existing codebase pattern for singleton services
- Private writable signal `_theme = signal<ThemeMode>('auto')` for raw user preference
- Public readonly signal `theme = this._theme.asReadonly()` per Angular 19 signal best practices
- Public `resolvedTheme = computed<ResolvedTheme>(() => ...)` that resolves `'auto'` by checking `window.matchMedia('(prefers-color-scheme: dark)').matches`, returning `'dark'` or `'light'`. If mode is `'light'` or `'dark'`, return directly.
- Constructor logic:
  1. Initialize from localStorage: `try { const stored = localStorage.getItem(THEME_STORAGE_KEY); }` — if stored value is `'light'`, `'dark'`, or `'auto'`, set signal. If null or invalid, default to `'auto'`. Wrap in try/catch for private browsing (per user decision: silent fallback to auto, console.warn only).
  2. Create `effect()` that reads `resolvedTheme()` and applies to DOM: `document.documentElement.setAttribute('data-bs-theme', resolved)`. This effect ONLY reads signals and writes to DOM — no signal writes inside effect (avoids infinite loop per research anti-pattern).
  3. Set up storage event listener for multi-tab sync: `window.addEventListener('storage', handler)`. Handler checks `event.key === THEME_STORAGE_KEY` and `event.newValue`, validates it's a valid ThemeMode, then calls `this._theme.set(validValue)`. Store handler reference for cleanup.
  4. Set up OS preference change listener: `this._mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')`. Add `'change'` event listener that checks `if (this._theme() === 'auto')` and forces re-evaluation by calling `this._theme.set('auto')` (same-value set triggers computed re-evaluation per research Pattern 4). Store listener reference for cleanup.
- `setTheme(mode: ThemeMode): void` method:
  1. `this._theme.set(mode)` — updates signal (effect auto-applies to DOM)
  2. Try `localStorage.setItem(THEME_STORAGE_KEY, mode)`, catch and `console.warn` on failure
- Implement `OnDestroy`: clean up both storage and media query listeners via `window.removeEventListener`
- Use double quotes, semicolons, 2-space indentation per codebase conventions
- Import order: Angular core first, then local types

**Important:** Do NOT use `fromEvent`/RxJS for the storage listener. The research suggests it as "BEST" but the locked decision says "storage event listener" and the codebase ThemeService is signal-based, not RxJS-based. Use plain addEventListener with manual cleanup in ngOnDestroy.

**Important:** The `_theme.set('auto')` same-value assignment in the media query listener is intentional — it forces the `computed` signal to re-run `window.matchMedia` which may now return a different result. Document this with a comment.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/angular && npx ng build --configuration development 2>&1 | tail -20`
Verify: Build succeeds with no TypeScript errors. Both files exist and are syntactically valid.
  </verify>
  <done>
ThemeService exists with: signal-based state (private writable + public readonly), computed resolvedTheme, localStorage persistence with try/catch, storage event listener for multi-tab sync, media query listener for OS preference changes, proper OnDestroy cleanup. ThemeMode and ResolvedTheme types exported.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add FOUC prevention script and register ThemeService</name>
  <files>
    src/angular/src/index.html
    src/angular/src/app/app.config.ts
    src/angular/src/styles.scss
  </files>
  <action>
**index.html — Add inline FOUC prevention script:**
Insert a `<script>` block inside `<head>`, AFTER the `<base href="/">` tag and BEFORE `<meta name="viewport">`. This script MUST be:
- Inline (not external file) — must execute synchronously before any rendering
- Wrapped in IIFE to avoid global namespace pollution
- Logic (MUST match ThemeService resolution logic exactly):
  1. `try { var stored = localStorage.getItem('theme'); } catch(e) { var stored = null; }`
  2. If `stored === 'light'` or `stored === 'dark'`, use stored value directly
  3. Otherwise (stored is `'auto'`, null, or anything invalid): check `window.matchMedia('(prefers-color-scheme: dark)').matches` — if true use `'dark'`, else use `'light'`
  4. `document.documentElement.setAttribute('data-bs-theme', resolved)`
- Add a comment above the script: `<!-- Theme: Apply before render to prevent FOUC -->`
- Use `var` (not `const`/`let`) in the inline script for maximum browser compatibility in the blocking script context
- The storage key string `'theme'` must match `THEME_STORAGE_KEY` in theme.types.ts

**index.html — Update meta theme-color:**
Change the existing `<meta name="theme-color" content="#f5f5f5">` to be dynamic. Since the meta tag is static HTML and we need it to match the theme, leave it as `#f5f5f5` for now (light default). Add a comment: `<!-- TODO: Phase 31 will update theme-color dynamically via ThemeService -->`. This is acceptable because the FOUC script handles the actual theme application; the meta tag is only for browser chrome color.

**app.config.ts — Register ThemeService:**
- Import `ThemeService` from `./services/theme/theme.service`
- Add ThemeService to providers array as an `APP_INITIALIZER` using the existing `dummyFactory` pattern (same as ViewFileFilterService, ViewFileSortService, VersionCheckService). This ensures ThemeService is instantiated at boot even though no component directly injects it yet.
- Add the APP_INITIALIZER entry AFTER the existing VersionCheckService initializer:
```typescript
{
    provide: APP_INITIALIZER,
    useFactory: dummyFactory,
    deps: [ThemeService],
    multi: true
},
```

**styles.scss — Update hardcoded background-color:**
The current `html, body { background-color: #f5f5f5; }` hardcodes a light background. This will flash white even in dark mode before Bootstrap's dark mode CSS loads. Change it to use CSS custom property:
```scss
html, body {
    font-family: Verdana,sans-serif;
    font-size: 15px;
    line-height: 1.5;
    margin: 0;
    // Uses Bootstrap's body-bg CSS variable which updates with data-bs-theme
    background-color: var(--bs-body-bg, #f5f5f5);
}
```
This way, when `data-bs-theme="dark"` is set, Bootstrap's CSS variable provides the dark background; the `#f5f5f5` is the fallback if the variable isn't loaded yet.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/angular && npx ng build --configuration development 2>&1 | tail -20`
Verify: Build succeeds. Check the built index.html contains the inline script with `data-bs-theme` and `localStorage.getItem('theme')`.
Also run: `cd /Users/julianamacbook/seedsync/src/angular && npm run lint 2>&1 | tail -20`
Verify: No new lint errors introduced.
  </verify>
  <done>
index.html has inline FOUC prevention script that reads localStorage and applies data-bs-theme before rendering. ThemeService registered via APP_INITIALIZER in app.config.ts. styles.scss uses var(--bs-body-bg) instead of hardcoded background color. Full build succeeds. Lint passes.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/julianamacbook/seedsync/src/angular && npx ng build --configuration development` succeeds
2. `cd /Users/julianamacbook/seedsync/src/angular && npm run lint` passes
3. Built index.html contains inline script with `data-bs-theme` attribute manipulation
4. ThemeService file contains: signal, computed, effect, storage listener, media query listener, ngOnDestroy cleanup
5. app.config.ts imports and registers ThemeService
</verification>

<success_criteria>
- ThemeService created with signal-based state, localStorage persistence, multi-tab sync, OS preference detection
- FOUC prevention inline script in index.html with matching resolution logic
- ThemeService registered as APP_INITIALIZER in app.config.ts
- styles.scss uses CSS variable for background-color
- Angular build succeeds with no errors
- ESLint passes with no new errors
</success_criteria>

<output>
After completion, create `.planning/phases/29-theme-infrastructure/29-01-SUMMARY.md`
</output>
