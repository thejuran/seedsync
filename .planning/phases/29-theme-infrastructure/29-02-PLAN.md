---
phase: 29-theme-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["29-01"]
files_modified:
  - src/angular/src/app/tests/unittests/services/theme/theme.service.spec.ts
autonomous: true

must_haves:
  truths:
    - "ThemeService unit tests cover all 6 THEME requirements"
    - "Tests verify signal state, localStorage persistence, multi-tab sync, and OS preference detection"
    - "All existing tests continue to pass alongside new tests"
  artifacts:
    - path: "src/angular/src/app/tests/unittests/services/theme/theme.service.spec.ts"
      provides: "Unit tests for ThemeService"
      min_lines: 100
  key_links:
    - from: "src/angular/src/app/tests/unittests/services/theme/theme.service.spec.ts"
      to: "src/angular/src/app/services/theme/theme.service.ts"
      via: "imports and tests ThemeService"
      pattern: "import.*ThemeService"
---

<objective>
Write unit tests for ThemeService covering all THEME-01 through THEME-06 requirements: Bootstrap data-bs-theme attribute application, light default preservation, localStorage persistence, OS preference detection, multi-tab sync, and FOUC-safe initialization.

Purpose: Verify the theme infrastructure works correctly and prevent regressions as Phase 30-32 build on top of it.
Output: Comprehensive test suite for ThemeService that passes in Karma/Jasmine.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-theme-infrastructure/29-01-SUMMARY.md
@src/angular/src/app/services/theme/theme.service.ts
@src/angular/src/app/services/theme/theme.types.ts
@src/angular/src/app/tests/unittests/services/settings/config.service.spec.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ThemeService unit tests</name>
  <files>
    src/angular/src/app/tests/unittests/services/theme/theme.service.spec.ts
  </files>
  <action>
Create a comprehensive test suite for ThemeService using the project's existing Karma/Jasmine test patterns (see config.service.spec.ts for conventions).

**Test setup:**
- Use `TestBed.configureTestingModule` to create the service
- Mock browser APIs before each test:
  - `spyOn(localStorage, 'getItem')` and `spyOn(localStorage, 'setItem')` for storage tests
  - Create a mock `MediaQueryList` object with controllable `.matches` property and `addEventListener`/`removeEventListener` methods. Use `spyOn(window, 'matchMedia').and.returnValue(mockMediaQuery)` to intercept OS preference checks
  - Use `spyOn(document.documentElement, 'setAttribute')` to verify DOM attribute changes
  - Track `window.addEventListener` and `window.removeEventListener` calls for storage event listener verification
- Use `TestBed.flushEffects()` after signal changes to ensure Angular effects run in tests (Angular 19 testing pattern for signals)
- Reset all mocks in `afterEach` to prevent test pollution

**Test cases to cover:**

1. **Initialization - default (THEME-02, THEME-06):**
   - When localStorage has no stored theme, service initializes with `'auto'` mode
   - Signal `theme()` returns `'auto'`

2. **Initialization - stored value (THEME-06):**
   - When localStorage has `'dark'`, service initializes with `'dark'`
   - When localStorage has `'light'`, service initializes with `'light'`
   - When localStorage has `'auto'`, service initializes with `'auto'`
   - When localStorage has invalid value (e.g. `'invalid'`), service defaults to `'auto'`

3. **Initialization - localStorage error (private browsing):**
   - When localStorage.getItem throws, service defaults to `'auto'` without throwing
   - Console.warn is called (spy on console.warn)

4. **Resolved theme computation (THEME-01, THEME-04):**
   - When mode is `'light'`, `resolvedTheme()` returns `'light'`
   - When mode is `'dark'`, `resolvedTheme()` returns `'dark'`
   - When mode is `'auto'` and OS prefers dark, `resolvedTheme()` returns `'dark'`
   - When mode is `'auto'` and OS prefers light (matchMedia returns false), `resolvedTheme()` returns `'light'`

5. **DOM attribute application (THEME-01):**
   - After initialization, `document.documentElement.setAttribute` is called with `'data-bs-theme'` and the resolved theme
   - After `setTheme('dark')`, attribute is updated to `'dark'`
   - After `setTheme('light')`, attribute is updated to `'light'`

6. **setTheme method (THEME-06):**
   - `setTheme('dark')` updates the `theme()` signal to `'dark'`
   - `setTheme('dark')` calls `localStorage.setItem('theme', 'dark')`
   - When localStorage.setItem throws, service does not throw (catches silently)
   - Console.warn is called when setItem fails

7. **Multi-tab sync (THEME-05):**
   - Service registers a `'storage'` event listener on window during construction
   - When a storage event fires with `key: 'theme'` and `newValue: 'dark'`, the `theme()` signal updates to `'dark'`
   - When a storage event fires with a different key (e.g. `'other'`), theme signal is unchanged
   - When a storage event fires with `newValue: null` (item removed), theme signal is unchanged

8. **OS preference change detection (THEME-04):**
   - Service registers a `'change'` listener on the MediaQueryList
   - When OS preference changes while mode is `'auto'`, `resolvedTheme()` updates accordingly

9. **Cleanup (memory safety):**
   - On `ngOnDestroy()`, the storage event listener is removed from window
   - On `ngOnDestroy()`, the media query change listener is removed

**Conventions:**
- Use double quotes for strings
- Use `describe("Testing theme service", () => { ... })` as outer block
- Use nested `describe` blocks for grouping related tests
- Follow codebase pattern: `import {fakeAsync, TestBed, tick} from "@angular/core/testing";`
- Import from relative paths: `import {ThemeService} from "../../../../services/theme/theme.service";`
- Import types: `import {ThemeMode, THEME_STORAGE_KEY} from "../../../../services/theme/theme.types";`

**Important:** Since ThemeService uses `providedIn: 'root'`, you need to either inject it directly via `TestBed.inject(ThemeService)` or configure it explicitly. The mocks for `window.matchMedia` and `localStorage` MUST be set up BEFORE `TestBed.inject` because the constructor runs immediately on injection and reads localStorage / sets up matchMedia.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/angular && npx ng test --watch=false --browsers=ChromeHeadless 2>&1 | tail -40`
Verify: All tests pass, including the new ThemeService tests and all existing tests. Zero test failures.
  </verify>
  <done>
ThemeService test suite exists with tests covering: initialization (default/stored/error), resolved theme computation, DOM attribute application, setTheme persistence, multi-tab sync via storage events, OS preference change detection, and ngOnDestroy cleanup. All tests pass alongside existing test suite.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/julianamacbook/seedsync/src/angular && npx ng test --watch=false --browsers=ChromeHeadless` â€” all tests pass
2. Test file covers all 6 THEME requirements (THEME-01 through THEME-06)
3. No existing tests broken by new additions
</verification>

<success_criteria>
- theme.service.spec.ts exists with at minimum 15 test cases
- All ThemeService tests pass
- All existing Angular tests continue to pass
- Tests cover: initialization, signal state, localStorage read/write, DOM attribute, multi-tab sync, OS preference, cleanup
</success_criteria>

<output>
After completion, create `.planning/phases/29-theme-infrastructure/29-02-SUMMARY.md`
</output>
