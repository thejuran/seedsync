---
phase: 23-api-client-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/python/controller/sonarr_manager.py
  - src/python/controller/controller_persist.py
  - src/python/controller/controller.py
  - src/python/controller/__init__.py
autonomous: true

must_haves:
  truths:
    - "Backend polls Sonarr queue API every 60 seconds when integration enabled"
    - "Backend detects when files disappear from Sonarr queue (import completion signal)"
    - "Backend detects when queue items transition to imported state"
    - "Imported filenames persist across app restarts"
    - "Import detection works only for files SeedSync manages (not all Sonarr activity)"
    - "First poll after startup populates state without false detections"
    - "Network errors do not cause false import detections"
    - "Backend logs include Sonarr API polling activity and detected imports"
  artifacts:
    - path: "src/python/controller/sonarr_manager.py"
      provides: "SonarrManager class with poll/detect logic"
      min_lines: 100
    - path: "src/python/controller/controller_persist.py"
      provides: "imported_file_names BoundedOrderedSet"
      contains: "imported_file_names"
    - path: "src/python/controller/controller.py"
      provides: "SonarrManager integration in Controller"
      contains: "SonarrManager"
    - path: "src/python/controller/__init__.py"
      provides: "SonarrManager export"
      contains: "SonarrManager"
  key_links:
    - from: "src/python/controller/controller.py"
      to: "src/python/controller/sonarr_manager.py"
      via: "SonarrManager instantiation in __init__ and process() call"
      pattern: "SonarrManager\\(context"
    - from: "src/python/controller/controller.py"
      to: "src/python/controller/controller_persist.py"
      via: "Adding imported files to persist.imported_file_names"
      pattern: "persist\\.imported_file_names\\.add"
    - from: "src/python/controller/sonarr_manager.py"
      to: "Sonarr API"
      via: "requests.get to /api/v3/queue"
      pattern: "requests\\.get.*api/v3/queue"
---

<objective>
Implement SonarrManager class, add imported_file_names persistence, and integrate into the Controller.

Purpose: Enable the backend to poll Sonarr's queue API every 60 seconds, detect when SeedSync-managed files are imported by Sonarr (via queue disappearance or state transition to "imported"), and persist detected imports across restarts.

Output: Working SonarrManager integrated into Controller.process() loop, with imported filenames tracked in ControllerPersist.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-api-client-integration/23-RESEARCH.md
@.planning/phases/22-configuration-settings-ui/22-01-SUMMARY.md
@src/python/controller/controller.py
@src/python/controller/controller_persist.py
@src/python/controller/scan_manager.py
@src/python/controller/__init__.py
@src/python/common/bounded_ordered_set.py
@src/python/common/config.py
@src/python/common/context.py
@src/python/web/handler/config.py
@src/python/seedsync.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SonarrManager class with queue polling and import detection</name>
  <files>src/python/controller/sonarr_manager.py</files>
  <action>
Create a new file `src/python/controller/sonarr_manager.py` implementing the SonarrManager class. Follow the Manager pattern established by ScanManager and LftpManager.

**Class structure:**

```python
import logging
import time
from typing import Optional, List, Set

import requests

from common import Context


class SonarrManager:
    """
    Manages Sonarr queue polling and import detection.
    """

    POLL_INTERVAL_SECS = 60

    def __init__(self, context: Context):
        ...

    def process(self, model_file_names: Set[str]) -> List[str]:
        """
        Called each controller cycle. Polls Sonarr if interval elapsed.
        Returns list of newly imported file names (empty most cycles).
        model_file_names: set of ModelFile.name values currently in the model.
        """
        ...
```

**Constructor (`__init__`):**
- Accept `context: Context` parameter (same as ScanManager pattern)
- Create child logger: `self.logger = context.logger.getChild("SonarrManager")`
- Store config references: read `context.config.sonarr.enabled`, `context.config.sonarr.sonarr_url`, `context.config.sonarr.sonarr_api_key` into private attributes
- Initialize `self.__last_poll_time = None` (float timestamp, None means never polled)
- Initialize `self.__previous_queue_names = None` (None means first poll not done yet; this is CRITICAL for first-poll bootstrap -- None is different from empty set)
- Initialize `self.__previous_queue_states = {}` (dict mapping title->trackedDownloadState from last poll)

**`process(self, model_file_names: Set[str]) -> List[str]` method:**
- If not enabled (`context.config.sonarr.enabled` is False), return empty list immediately. Re-read `context.config.sonarr.enabled` each call (not cached from __init__) so toggling in settings takes effect without restart.
- Also re-read `context.config.sonarr.sonarr_url` and `context.config.sonarr.sonarr_api_key` each call for the same reason.
- Check time interval: if `self.__last_poll_time` is not None and `time.time() - self.__last_poll_time < POLL_INTERVAL_SECS`, return empty list.
- Otherwise, update `self.__last_poll_time = time.time()` and call `self._poll_and_detect(model_file_names)`.

**`_fetch_queue(self) -> Optional[List[dict]]` method:**
- Strip trailing slash from sonarr_url.
- Make GET request to `{url}/api/v3/queue` with headers `{"X-Api-Key": api_key}`, params `{"pageSize": 200, "includeUnknownSeriesItems": True}`, timeout=10.
- On success (status 200): parse JSON, return `data.get("records", [])`.
- On non-200 status: log warning with status code, return None.
- On `requests.RequestException`: log warning with error message, return None.
- CRITICAL: Return None on error, NOT empty list. This prevents false positive import detection.

**`_poll_and_detect(self, model_file_names: Set[str]) -> List[str]` method:**
- Call `_fetch_queue()`. If result is None (error), log and return empty list. Do NOT update previous state.
- Build `current_queue_names`: set of `record["title"]` for each record in the queue response.
- Build `current_queue_states`: dict of `{record["title"]: record.get("trackedDownloadState", "")}` for each record.
- Log at debug level: "Sonarr queue poll: {} items in queue".format(len(records))
- **First-poll bootstrap:** If `self.__previous_queue_names is None`, this is the first successful poll. Set `self.__previous_queue_names = current_queue_names` and `self.__previous_queue_states = current_queue_states`. Log at info level: "Sonarr initial poll: {} items in queue (bootstrap, no detection)". Return empty list.
- **Detect imports via disappearance:** `disappeared = self.__previous_queue_names - current_queue_names`
- **Detect imports via state change:** For each title in `current_queue_states`, if `current_queue_states[title] == "imported"` AND (`title not in self.__previous_queue_states` OR `self.__previous_queue_states[title] != "imported"`), add to a `state_changed` set.
- **Combine detections:** `all_detected = disappeared | state_changed`
- **Filter to SeedSync-managed files:** Create `model_file_names_lower = {name.lower(): name for name in model_file_names}`. For each detected name, check if `detected_name.lower() in model_file_names_lower`. If yes, add the ORIGINAL model file name (not the Sonarr name) to the `newly_imported` list. This is case-insensitive matching.
- Log each detected import at info level: "Sonarr import detected: '{}' (matched SeedSync file '{}')".format(detected_name, original_name)
- Log any detected-but-unmatched names at debug level: "Sonarr queue item '{}' disappeared but not in SeedSync model".format(name)
- Update `self.__previous_queue_names = current_queue_names` and `self.__previous_queue_states = current_queue_states`.
- Return the `newly_imported` list.

**Logging requirements:**
- Use `self.logger` (child of context logger, so it appears as e.g. `seedsync.Controller.SonarrManager`)
- DEBUG: poll results (item count), unmatched disappearances
- INFO: first poll bootstrap, detected imports, enable/disable transitions
- WARNING: API errors (non-200 status, network errors)

**Do NOT:**
- Create a separate thread or use threading.Timer. The polling is driven by the controller's process() loop.
- Store full Sonarr queue response. Only store names and states.
- Add any new dependencies. Use `requests` which is already installed.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/python && python -c "from controller.sonarr_manager import SonarrManager; print('Import OK')"`

Verify the file exists and has the expected class with process(), _fetch_queue(), and _poll_and_detect() methods.
  </verify>
  <done>
SonarrManager class exists at src/python/controller/sonarr_manager.py with:
- process() method that checks enabled, checks interval, delegates to _poll_and_detect()
- _fetch_queue() that calls Sonarr /api/v3/queue with pageSize=200 and returns None on error
- _poll_and_detect() that handles first-poll bootstrap, detects imports via disappearance AND state change, filters to SeedSync model files via case-insensitive name match
- Comprehensive logging at DEBUG/INFO/WARNING levels
  </done>
</task>

<task type="auto">
  <name>Task 2: Add imported_file_names to ControllerPersist with backward compatibility</name>
  <files>src/python/controller/controller_persist.py</files>
  <action>
Modify `src/python/controller/controller_persist.py` to add `imported_file_names` tracking. Follow the exact same pattern as `downloaded_file_names`, `extracted_file_names`, and `stopped_file_names`.

**Changes to ControllerPersist class:**

1. **Add key constant** (after existing __KEY_STOPPED_FILE_NAMES):
   ```python
   __KEY_IMPORTED_FILE_NAMES = "imported"
   ```

2. **Add attribute in `__init__`** (after stopped_file_names initialization):
   ```python
   # Track files that Sonarr has imported - used for import detection
   # and preventing duplicate processing
   self.imported_file_names: BoundedOrderedSet[str] = BoundedOrderedSet(
       maxlen=self._max_tracked_files
   )
   ```

3. **Update `from_str()`** to load imported list with backward compatibility:
   After the `stopped_list` loading block (line ~90), add:
   ```python
   # imported_list is optional for backwards compatibility with old persist files
   imported_list = dct.get(ControllerPersist.__KEY_IMPORTED_FILE_NAMES, [])
   ```
   Then add the loading loop (same pattern as stopped_list):
   ```python
   for name in imported_list:
       evicted = persist.imported_file_names.add(name)
       if evicted:
           persist._logger.debug(
               "Evicted '{}' from imported files during load (limit: {})".format(
                   evicted, persist._max_tracked_files
               )
           )
   ```
   IMPORTANT: The `imported` key MUST be loaded via `dct.get()` (not `dct[]`) so old persist files without this key load successfully.

4. **Update `to_str()`** to include imported list:
   After the stopped_file_names line, add:
   ```python
   dct[ControllerPersist.__KEY_IMPORTED_FILE_NAMES] = self.imported_file_names.as_list()
   ```

5. **Update `get_eviction_stats()`** to include imported evictions:
   Add to the returned dict:
   ```python
   'imported_evictions': self.imported_file_names.total_evictions,
   ```

Do NOT change the existing downloaded/extracted/stopped logic. The imported key is additive only.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/python && python -c "
from controller.controller_persist import ControllerPersist
import json

# Test new persist
p = ControllerPersist()
p.imported_file_names.add('test.file')
s = p.to_str()
d = json.loads(s)
assert 'imported' in d, 'imported key missing from to_str()'
assert d['imported'] == ['test.file'], 'imported value wrong'

# Test backward compatibility (no imported key)
old_content = json.dumps({'downloaded': ['a'], 'extracted': ['b']})
p2 = ControllerPersist.from_str(old_content)
assert len(p2.imported_file_names) == 0, 'imported should be empty for old persist'
print('All persist checks passed')
"`
  </verify>
  <done>
ControllerPersist has imported_file_names BoundedOrderedSet that:
- Serializes to/from JSON with key "imported"
- Loads with backward compatibility (old persist files without "imported" key default to empty list)
- Included in get_eviction_stats()
- Same eviction behavior as downloaded/extracted/stopped sets
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate SonarrManager into Controller and update module exports</name>
  <files>src/python/controller/controller.py, src/python/controller/__init__.py</files>
  <action>
**Part A: Update controller.py**

1. **Add import** at top of file (after existing manager imports):
   ```python
   from .sonarr_manager import SonarrManager
   ```

2. **Create SonarrManager in `__init__`** (after the file_op_manager setup, around line 123):
   ```python
   # Setup the Sonarr manager
   self.__sonarr_manager = SonarrManager(context=self.__context)
   ```

3. **Register imported_file_names in memory monitor** (after the stopped_evictions registration, around line 158):
   ```python
   self.__memory_monitor.register_data_source(
       'imported_files',
       lambda: len(self.__persist.imported_file_names)
   )
   self.__memory_monitor.register_data_source(
       'imported_evictions',
       lambda: self.__persist.imported_file_names.total_evictions
   )
   ```

4. **Add `__check_sonarr_imports` private method** (after the `__update_model` method, before `__handle_queue_command`):
   ```python
   def __check_sonarr_imports(self):
       """
       Poll Sonarr for newly imported files and update persist state.
       """
       # Get current model file names for matching
       model_file_names = set(self.__model.get_file_names())

       newly_imported = self.__sonarr_manager.process(model_file_names)

       for file_name in newly_imported:
           self.__persist.imported_file_names.add(file_name)
           self.logger.info("Recorded Sonarr import: '{}'".format(file_name))
   ```

5. **Call from `process()` method** -- add at the end of the process() method, after `self.__memory_monitor.log_stats_if_due()`:
   ```python
   # Poll Sonarr for imported files
   self.__check_sonarr_imports()
   ```
   The full process() method should end with:
   ```python
   self.__update_model()
   # Periodically log memory statistics
   self.__memory_monitor.log_stats_if_due()
   # Poll Sonarr for imported files
   self.__check_sonarr_imports()
   ```

**Part B: Update __init__.py**

Add SonarrManager to the module exports. Add this line after the existing imports (e.g., after the `from .scan_manager import ScanManager` line):
```python
from .sonarr_manager import SonarrManager
```

**Do NOT:**
- Call SonarrManager from __update_model(). It should be a separate step in process() since it's an independent concern from model updates.
- Add SonarrManager to controller.start() or controller.exit(). SonarrManager has no background processes to start/stop.
- Pass persist to SonarrManager. The Controller owns the persist and records imports based on SonarrManager's return value.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/python && python -c "
from controller import SonarrManager
from controller.controller import Controller
import inspect

# Verify SonarrManager is importable from controller package
print('SonarrManager import from controller: OK')

# Verify Controller references SonarrManager
source = inspect.getsource(Controller.__init__)
assert 'SonarrManager' in source, 'SonarrManager not in Controller.__init__'
print('SonarrManager in Controller.__init__: OK')

# Verify process() calls __check_sonarr_imports
source = inspect.getsource(Controller.process)
assert 'sonarr' in source.lower(), 'sonarr not in Controller.process()'
print('Sonarr check in Controller.process(): OK')

# Verify memory monitor registration
source = inspect.getsource(Controller.__init__)
assert 'imported_files' in source, 'imported_files not in memory monitor'
print('Memory monitor imported_files: OK')

print('All integration checks passed')
"`

Also run existing tests to verify no regressions:
`cd /Users/julianamacbook/seedsync/src/python && python -m pytest tests/unittests/test_controller/test_controller_persist.py -v`
  </verify>
  <done>
Controller integration complete:
- SonarrManager instantiated in Controller.__init__ with context
- Controller.process() calls __check_sonarr_imports() after model update and memory monitor
- __check_sonarr_imports() passes model file names to SonarrManager.process() and records returned imports in persist.imported_file_names
- Memory monitor tracks imported_files count and imported_evictions
- SonarrManager exported from controller package __init__.py
- Existing controller persist tests still pass
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/julianamacbook/seedsync/src/python && python -c "from controller.sonarr_manager import SonarrManager; print('SonarrManager import OK')"`
2. `cd /Users/julianamacbook/seedsync/src/python && python -c "from controller import SonarrManager; print('Package export OK')"`
3. `cd /Users/julianamacbook/seedsync/src/python && python -m pytest tests/unittests/test_controller/test_controller_persist.py -v` (no regressions)
4. Verify backward compatibility: old persist files (without "imported" key) load without error
5. Verify SonarrManager.process() returns empty list when disabled
6. Verify Controller.process() includes sonarr import check
</verification>

<success_criteria>
- SonarrManager class exists with poll interval logic, queue fetching, and import detection
- Import detection uses BOTH queue disappearance AND trackedDownloadState=="imported" signals
- First poll bootstraps previous state without false detections (previous_queue_names starts as None)
- Network errors return None from _fetch_queue(), preventing false positives
- Name matching between Sonarr queue titles and ModelFile names is case-insensitive
- ControllerPersist.imported_file_names serializes/deserializes with backward compatibility
- Controller.process() calls SonarrManager.process() and records results in persist
- Memory monitor tracks imported_files and imported_evictions
- SonarrManager exported from controller package
- All existing tests pass without regression
</success_criteria>

<output>
After completion, create `.planning/phases/23-api-client-integration/23-01-SUMMARY.md`
</output>
