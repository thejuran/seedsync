---
phase: 23-api-client-integration
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - src/python/tests/unittests/test_controller/test_sonarr_manager.py
  - src/python/tests/unittests/test_controller/test_controller_persist.py
  - src/python/tests/unittests/test_controller/test_controller_unit.py
autonomous: true

must_haves:
  truths:
    - "Poll interval timing is tested (only polls when 60s elapsed)"
    - "Import detection via queue item state change to imported is tested"
    - "Import detection via queue item disappearance is tested"
    - "First-poll bootstrap is tested (no false detections on first poll)"
    - "Network error handling is tested (None vs empty list)"
    - "Disabled state is tested (no polling when sonarr.enabled is False)"
    - "Case-insensitive name matching between Sonarr and SeedSync is tested"
    - "Filtering to SeedSync-managed files only is tested"
    - "Imported_file_names serialization roundtrip is tested"
    - "Backward compatibility (missing imported key) is tested"
    - "Controller integration with SonarrManager is tested"
  artifacts:
    - path: "src/python/tests/unittests/test_controller/test_sonarr_manager.py"
      provides: "SonarrManager unit tests"
      min_lines: 200
    - path: "src/python/tests/unittests/test_controller/test_controller_persist.py"
      provides: "Updated persist tests with imported_file_names"
      contains: "imported"
    - path: "src/python/tests/unittests/test_controller/test_controller_unit.py"
      provides: "Controller unit tests with SonarrManager mock"
      contains: "sonarr"
  key_links:
    - from: "src/python/tests/unittests/test_controller/test_sonarr_manager.py"
      to: "src/python/controller/sonarr_manager.py"
      via: "direct import and test of SonarrManager"
      pattern: "from controller.sonarr_manager import SonarrManager"
    - from: "src/python/tests/unittests/test_controller/test_controller_persist.py"
      to: "src/python/controller/controller_persist.py"
      via: "test of imported_file_names serialization"
      pattern: "imported_file_names"
---

<objective>
Write comprehensive unit tests for SonarrManager and update existing tests for ControllerPersist and Controller.

Purpose: Verify all import detection logic, edge cases, and integration points. Ensure poll timing, bootstrap behavior, error handling, and name matching work correctly.

Output: Full test coverage of SonarrManager, updated persist tests, and updated controller tests.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-api-client-integration/23-RESEARCH.md
@.planning/phases/23-api-client-integration/23-01-SUMMARY.md
@src/python/controller/sonarr_manager.py
@src/python/controller/controller_persist.py
@src/python/controller/controller.py
@src/python/tests/unittests/test_controller/test_controller_persist.py
@src/python/tests/unittests/test_controller/test_controller_unit.py
@src/python/tests/unittests/test_controller/test_scan_manager.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive SonarrManager unit tests</name>
  <files>src/python/tests/unittests/test_controller/test_sonarr_manager.py</files>
  <action>
Create a new test file `src/python/tests/unittests/test_controller/test_sonarr_manager.py`. Follow the test patterns from test_scan_manager.py (MagicMock context, unittest.TestCase, setUp with mocked dependencies).

**Test class setup (`TestSonarrManager`):**

```python
import unittest
from unittest.mock import MagicMock, patch
import time

from controller.sonarr_manager import SonarrManager
```

`setUp` method:
- Create `self.mock_context = MagicMock()`
- Set `self.mock_context.logger = MagicMock()`
- Set `self.mock_context.config.sonarr.enabled = True`
- Set `self.mock_context.config.sonarr.sonarr_url = "http://localhost:8989"`
- Set `self.mock_context.config.sonarr.sonarr_api_key = "test-api-key"`
- Create `self.manager = SonarrManager(context=self.mock_context)`
- Define helper `self.model_file_names` as a set of test file names

**Helper method to create mock queue records:**
```python
def _make_record(self, title, state="downloading"):
    return {"title": title, "trackedDownloadState": state}
```

**Required test methods (use `@patch('controller.sonarr_manager.requests')` to mock HTTP calls):**

1. **`test_disabled_returns_empty`**
   - Set `self.mock_context.config.sonarr.enabled = False`
   - Call `manager.process(model_file_names)` -- should return `[]`
   - Verify requests.get was NOT called

2. **`test_poll_interval_skips_when_not_elapsed`**
   - First call: mock successful API response with records, verify it calls requests.get
   - Second call immediately: verify requests.get was NOT called again (interval not elapsed)
   - Return value should be `[]` on second call

3. **`test_poll_interval_polls_when_elapsed`**
   - First call with mocked response
   - Manually set `manager._SonarrManager__last_poll_time = time.time() - 61` (simulate 61s elapsed)
   - Second call: verify requests.get IS called again

4. **`test_first_poll_bootstrap_no_detections`**
   - Mock API returning 2 records: `[_make_record("File.A"), _make_record("File.B")]`
   - model_file_names contains "File.A" and "File.B"
   - First call to process() should return `[]` (bootstrap, no detections)
   - Verify info log about bootstrap was called

5. **`test_detect_import_via_disappearance`**
   - First poll: mock API with records `["File.A", "File.B"]` in downloading state
   - Call process() -- returns [] (bootstrap)
   - Advance time past interval
   - Second poll: mock API with only `["File.B"]` (File.A disappeared)
   - model_file_names contains "File.A" and "File.B"
   - Call process() -- should return `["File.A"]`

6. **`test_detect_import_via_state_change`**
   - First poll: mock API with `[_make_record("File.A", "importPending")]`
   - Call process() -- returns [] (bootstrap)
   - Advance time past interval
   - Second poll: mock API with `[_make_record("File.A", "imported")]`
   - model_file_names contains "File.A"
   - Call process() -- should return `["File.A"]`

7. **`test_detect_import_via_both_signals`**
   - First poll: `[_make_record("File.A", "importPending"), _make_record("File.B", "downloading")]`
   - Bootstrap (returns [])
   - Advance time
   - Second poll: `[_make_record("File.A", "imported")]` (File.B disappeared, File.A state changed)
   - model_file_names contains both
   - Should return both "File.A" and "File.B" (or just unique set of them)

8. **`test_network_error_returns_empty_no_state_update`**
   - First poll: successful with `["File.A", "File.B"]` (bootstrap)
   - Advance time
   - Second poll: mock requests.get raising `requests.RequestException`
   - Should return `[]`
   - Advance time
   - Third poll: successful with `["File.B"]` only (File.A gone)
   - Should still detect File.A disappearance (because state was not updated on error)

9. **`test_non_200_status_returns_empty`**
   - Mock response with status_code=500
   - Call process() -- should return `[]`
   - Verify warning was logged

10. **`test_filter_to_seedsync_files_only`**
    - First poll: `["File.A", "File.B", "External.File"]` (bootstrap)
    - Advance time
    - Second poll: `["External.File"]` (File.A and File.B disappeared)
    - model_file_names contains only "File.A" and "File.B" (not "External.File")
    - Should return `["File.A", "File.B"]` -- only SeedSync-managed files

11. **`test_unmatched_disappearance_logged_at_debug`**
    - First poll: `["File.A", "Unknown.File"]` (bootstrap)
    - Advance time
    - Second poll: `["File.A"]` (Unknown.File disappeared)
    - model_file_names contains only "File.A"
    - Should return `[]` (Unknown.File not in model)
    - Verify debug log about unmatched disappearance

12. **`test_case_insensitive_name_matching`**
    - First poll: `[_make_record("file.a.720p")]` (bootstrap)
    - Advance time
    - Second poll: `[]` (file.a.720p disappeared)
    - model_file_names contains "File.A.720p" (different case)
    - Should return `["File.A.720p"]` (the ORIGINAL model file name, not the Sonarr name)

13. **`test_api_call_params`**
    - Verify requests.get is called with correct URL (`{url}/api/v3/queue`), headers (`X-Api-Key`), params (`pageSize: 200, includeUnknownSeriesItems: True`), and timeout (10)

14. **`test_url_trailing_slash_stripped`**
    - Set sonarr_url to "http://localhost:8989/"
    - Verify requests.get URL does NOT have double slash

15. **`test_already_imported_state_not_redetected`**
    - First poll: `[_make_record("File.A", "imported")]` (bootstrap)
    - Advance time
    - Second poll: `[_make_record("File.A", "imported")]` (still imported, no change)
    - Should return `[]` (no new detection -- state didn't change between polls)

**Mocking pattern for requests:**
Use `@patch('controller.sonarr_manager.requests')` at the test method level. Mock `requests.get` to return a MagicMock with `status_code=200` and `json()` returning `{"records": [...]}`.

For advancing time between polls, directly set `manager._SonarrManager__last_poll_time = time.time() - 61`.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/seedsync/src/python && python -m pytest tests/unittests/test_controller/test_sonarr_manager.py -v`

All tests should pass. Verify at least 12 test methods exist.
  </verify>
  <done>
test_sonarr_manager.py has 15+ test methods covering:
- Disabled state (no polling)
- Poll interval timing (skip when not elapsed, poll when elapsed)
- First-poll bootstrap (no false detections)
- Import detection via disappearance
- Import detection via state change to "imported"
- Combined detection (both signals)
- Network error handling (no state update, no false positives)
- Non-200 status code handling
- Filtering to SeedSync-managed files only
- Unmatched disappearance logging
- Case-insensitive name matching (returns original model name)
- API call parameters verification
- URL trailing slash handling
- Already-imported state not re-detected
All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update ControllerPersist tests and Controller unit tests</name>
  <files>src/python/tests/unittests/test_controller/test_controller_persist.py, src/python/tests/unittests/test_controller/test_controller_unit.py</files>
  <action>
**Part A: Update test_controller_persist.py**

Add the following test methods to the existing `TestControllerPersist` class:

1. **`test_imported_file_names_roundtrip`**
   - Create persist, add items to imported_file_names
   - Serialize with to_str(), deserialize with from_str()
   - Assert imported_file_names match

2. **`test_imported_file_names_in_to_str`**
   - Create persist, add items to imported_file_names
   - Serialize with to_str(), parse JSON
   - Assert "imported" key exists with correct values

3. **`test_backward_compatibility_no_imported_key`**
   - Create JSON string with only "downloaded" and "extracted" keys (no "imported")
   - Call from_str() -- should succeed
   - Assert imported_file_names is empty (len == 0)
   - This is the critical backward compatibility test

4. **`test_imported_eviction_stats`**
   - Create persist with max_tracked_files=2
   - Add 3 items to imported_file_names (triggers 1 eviction)
   - Call get_eviction_stats()
   - Assert 'imported_evictions' key exists and equals 1

5. **Update `test_to_str`** -- the existing test should still pass because imported_file_names will be empty (default). But verify the "imported" key appears in serialized output. Add assertion:
   ```python
   self.assertTrue("imported" in dct)
   self.assertEqual([], dct["imported"])
   ```

6. **Update `test_to_and_from_str`** -- add imported_file_names to the roundtrip test:
   ```python
   persist.imported_file_names.add("imp_one")
   persist.imported_file_names.add("imp_two")
   ```
   And verify after roundtrip:
   ```python
   self.assertEqual(
       persist.imported_file_names,
       persist_actual.imported_file_names
   )
   ```

**Part B: Update test_controller_unit.py**

The existing `BaseControllerTestCase` patches all internal dependencies. Since Plan 01 added `SonarrManager` as a new import in controller.py, the base test case needs updating:

1. **Add SonarrManager patch to `BaseControllerTestCase.setUp`**:
   After the existing patcher lines, add:
   ```python
   self.patcher_sonarr = patch('controller.controller.SonarrManager')
   self.mock_sonarr_manager_cls = self.patcher_sonarr.start()
   self.mock_sonarr_manager = self.mock_sonarr_manager_cls.return_value
   # Default: process returns empty list (no imports)
   self.mock_sonarr_manager.process.return_value = []
   ```

2. **Add to `tearDown`**:
   ```python
   self.patcher_sonarr.stop()
   ```

3. **Add test for sonarr import integration** in a new test class `TestControllerSonarrIntegration(BaseControllerTestCase)`:

   **`test_process_calls_sonarr_manager`**:
   - Call `_make_controller_started()`
   - Call `controller.process()`
   - Assert `self.mock_sonarr_manager.process.called` is True

   **`test_sonarr_imports_added_to_persist`**:
   - Call `_make_controller_started()`
   - Set `self.mock_sonarr_manager.process.return_value = ["File.A", "File.B"]`
   - Add "File.A" and "File.B" to the model (so get_file_names returns them)
   - Call `controller.process()`
   - Assert `"File.A" in self.persist.imported_file_names`
   - Assert `"File.B" in self.persist.imported_file_names`

   **`test_sonarr_disabled_no_imports`**:
   - Call `_make_controller_started()`
   - Set `self.mock_sonarr_manager.process.return_value = []`
   - Call `controller.process()`
   - Assert `len(self.persist.imported_file_names) == 0`

**IMPORTANT:** The existing tests in test_controller_unit.py must NOT break. The SonarrManager mock must be added to BaseControllerTestCase so all existing test classes that inherit from it still work. The default mock behavior (process returns []) ensures existing tests are unaffected.
  </action>
  <verify>
Run all controller tests:
```bash
cd /Users/julianamacbook/seedsync/src/python && python -m pytest tests/unittests/test_controller/ -v
```

All existing tests must pass (no regressions). New tests must pass. Specifically check:
- test_controller_persist.py: all existing + new imported tests pass
- test_controller_unit.py: all existing tests + new sonarr integration tests pass
- test_sonarr_manager.py: all new tests pass
  </verify>
  <done>
Test updates complete:
- test_controller_persist.py has imported_file_names roundtrip, to_str, backward compatibility, and eviction stats tests
- test_controller_unit.py BaseControllerTestCase patches SonarrManager; new TestControllerSonarrIntegration class verifies process() calls SonarrManager and records imports in persist
- All existing tests pass without regression
- All new tests pass
- Full test suite in test_controller/ is green
  </done>
</task>

</tasks>

<verification>
Run full controller test suite:
```bash
cd /Users/julianamacbook/seedsync/src/python && python -m pytest tests/unittests/test_controller/ -v
```

Expected:
- test_sonarr_manager.py: 15+ tests PASSED
- test_controller_persist.py: existing tests + 4+ new tests PASSED
- test_controller_unit.py: existing tests + 3 new tests PASSED
- All other test_controller/*.py: PASSED (no regressions)

Run broader test suite to check for regressions:
```bash
cd /Users/julianamacbook/seedsync/src/python && python -m pytest tests/unittests/ -v
```
</verification>

<success_criteria>
- SonarrManager has comprehensive unit tests covering all 5 success criteria from the phase
- Poll interval, bootstrap, disappearance detection, state change detection, error handling, name matching all tested
- ControllerPersist imported_file_names serialization tested including backward compatibility
- Controller integration tested (process() calls SonarrManager, imports added to persist)
- BaseControllerTestCase updated to mock SonarrManager (no regressions in existing tests)
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/23-api-client-integration/23-02-SUMMARY.md`
</output>
