---
phase: 20-ci-workflow-consolidation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .github/workflows/master.yml
  - .github/workflows/docker-publish.yml
autonomous: true

must_haves:
  truths:
    - "Push to master (after e2e tests pass) publishes ghcr.io/thejuran/seedsync:dev for both amd64 and arm64"
    - "Tag vX.Y.Z publishes ghcr.io/thejuran/seedsync:X.Y.Z and :latest for both architectures"
    - "PR to master does NOT trigger any Docker publishing"
    - "Only master.yml handles Docker publishing -- docker-publish.yml does not exist"
  artifacts:
    - path: ".github/workflows/master.yml"
      provides: "All CI jobs including :dev and versioned Docker publishing"
      contains: "publish-docker-image-dev"
    - path: ".github/workflows/docker-publish.yml"
      provides: "MUST NOT EXIST (deleted)"
  key_links:
    - from: "publish-docker-image-dev job"
      to: "e2etests-deb, e2etests-docker-image"
      via: "needs clause"
      pattern: "needs:.*e2etests"
    - from: "publish-docker-image-dev job"
      to: "make docker-image-release"
      via: "RELEASE_VERSION=dev"
      pattern: "RELEASE_VERSION=dev"
    - from: "publish-docker-image-dev if condition"
      to: "master push only"
      via: "github.ref == refs/heads/master"
      pattern: "github\\.ref == 'refs/heads/master'"
---

<objective>
Consolidate Docker publishing into master.yml by adding a :dev publishing job and removing docker-publish.yml.

Purpose: Eliminate the duplicate docker-publish.yml workflow that publishes independently from the main CI pipeline (skipping tests). All Docker publishing should flow through master.yml so that :dev images are only published after all tests pass.

Output: Updated master.yml with :dev publishing job, docker-publish.yml deleted.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.github/workflows/master.yml
@.github/workflows/docker-publish.yml
@Makefile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add :dev Docker publishing job to master.yml</name>
  <files>.github/workflows/master.yml</files>
  <action>
Add a new job `publish-docker-image-dev` to master.yml that publishes the `:dev` tag on every master push (not PRs, not tags). This job reuses the existing staging image that was already built and tested by `build-docker-image` and `e2etests-docker-image`.

The new job should:

1. Have `needs: [ e2etests-deb, e2etests-docker-image ]` (same as existing `publish-docker-image` job) so it only runs after ALL tests pass.

2. Use `if: github.ref == 'refs/heads/master'` to ensure it only runs on master push (not on tag pushes, not on PRs). This is the inverse of the existing `publish-docker-image` which uses `if: startsWith(github.ref, 'refs/tags/v')`.

3. Follow the exact same pattern as the existing `publish-docker-image` job for setup steps:
   - Checkout
   - Set up QEMU (docker/setup-qemu-action@v3)
   - Set up Docker Buildx (docker/setup-buildx-action@v3 with same driver-opts)
   - Log into GHCR (same docker login command)
   - Set staging registry env variable (same)

4. Call `make docker-image-release` with:
   - `STAGING_REGISTRY=${{ env.staging_registry }}`
   - `STAGING_VERSION=${{ github.run_number }}`
   - `RELEASE_REGISTRY=ghcr.io/thejuran`
   - `RELEASE_VERSION=dev`

This reuses the `docker-image-release` Makefile target which pulls from the staging cache and pushes to the release registry with `--platform linux/amd64,linux/arm64`, giving us proper multi-arch support. This is superior to what docker-publish.yml did (single arch only via docker/build-push-action).

Place the new job AFTER the existing `publish-docker-image` job and BEFORE `publish-deb` in the file, to keep all Docker publishing jobs together.

Do NOT remove the debug echo steps (`Show buildx builder instance name`, `Show buildx available platforms`) -- the existing jobs have them and consistency matters.
  </action>
  <verify>
Verify the YAML is valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/master.yml'))"` from the project root.

Also verify by inspection:
- `publish-docker-image-dev` job exists
- Has `if: github.ref == 'refs/heads/master'`
- Has `needs: [ e2etests-deb, e2etests-docker-image ]`
- Uses `make docker-image-release` with `RELEASE_VERSION=dev`
- Has `--platform linux/amd64,linux/arm64` (inherited from Makefile target)
  </verify>
  <done>
master.yml contains a `publish-docker-image-dev` job that will publish `ghcr.io/thejuran/seedsync:dev` (amd64 + arm64) on every master push, only after all e2e tests pass. The job does NOT run on PRs or tag pushes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Delete docker-publish.yml and update CLAUDE.md</name>
  <files>.github/workflows/docker-publish.yml, CLAUDE.md</files>
  <action>
1. Delete `.github/workflows/docker-publish.yml` entirely. This workflow is now redundant because:
   - Its `:dev` publishing on master push is handled by the new `publish-docker-image-dev` job in master.yml
   - Its version tag publishing was already handled by the existing `publish-docker-image` job in master.yml
   - The master.yml approach is superior: it gates on test passage and builds multi-arch

2. Update `CLAUDE.md` Key Files section: Remove the line that references `docker-publish.yml`:
   - Current: `.github/workflows/docker-publish.yml` - Docker image publish (`:dev` on master, `:X.Y.Z` on tags)
   - Remove this entire line since the file no longer exists. The existing `.github/workflows/master.yml` line already describes the CI pipeline.

Do NOT change any other content in CLAUDE.md.
  </action>
  <verify>
Verify docker-publish.yml is gone: `test ! -f .github/workflows/docker-publish.yml && echo "DELETED"` should print DELETED.

Verify CLAUDE.md no longer references docker-publish.yml: `grep -c "docker-publish" CLAUDE.md` should return 0.

Verify only expected workflow files remain: `ls .github/workflows/` should show only `master.yml`.
  </verify>
  <done>
docker-publish.yml is deleted. CLAUDE.md no longer references it. Only master.yml exists in `.github/workflows/` for Docker publishing. All Docker publishing (`:dev` on master push, `:X.Y.Z` + `:latest` on tags) is consolidated in master.yml.
  </done>
</task>

</tasks>

<verification>
1. YAML syntax valid: `python3 -c "import yaml; yaml.safe_load(open('.github/workflows/master.yml'))"`
2. docker-publish.yml deleted: `test ! -f .github/workflows/docker-publish.yml`
3. master.yml has both publishing jobs:
   - `publish-docker-image` (tags only, existing)
   - `publish-docker-image-dev` (master push only, new)
4. Both jobs gate on e2e test passage via `needs`
5. Both jobs use `make docker-image-release` which builds multi-arch (amd64 + arm64)
6. Mutual exclusion: dev job has `if: github.ref == 'refs/heads/master'`, tag job has `if: startsWith(github.ref, 'refs/tags/v')`
7. PR pushes trigger neither publishing job (PRs have `refs/pull/...` ref)
8. CLAUDE.md updated to remove docker-publish.yml reference
</verification>

<success_criteria>
- master.yml is the ONLY workflow handling Docker publishing
- `:dev` publishing runs on master push, after e2e tests pass, multi-arch
- `:X.Y.Z` + `:latest` publishing runs on tag push, after e2e tests pass, multi-arch (unchanged)
- docker-publish.yml no longer exists
- WKFL-01, WKFL-02, WKFL-03 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/20-ci-workflow-consolidation/20-01-SUMMARY.md`
</output>
