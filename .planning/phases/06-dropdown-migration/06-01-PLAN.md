---
phase: 06-dropdown-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/angular/src/app/common/_bootstrap-overrides.scss
  - src/angular/src/app/pages/files/file-options.component.scss
  - src/angular/src/app/pages/files/file-options.component.html
  - src/angular/src/app/pages/files/file-options.component.ts
autonomous: true

must_haves:
  truths:
    - "User clicks dropdown button and menu appears below (or above when near viewport bottom)"
    - "Dropdown menu has dark theme matching app colors"
    - "User can navigate dropdown items with arrow keys, Enter to select, Escape to close"
    - "Dropdown closes when user clicks outside or selects an option"
    - "Dropdown closes when user scrolls the file list"
    - "Disabled items appear greyed out (not hidden)"
  artifacts:
    - path: "src/angular/src/app/common/_bootstrap-overrides.scss"
      provides: "Dark dropdown theme via CSS variables"
      contains: "[data-bs-theme=\"dark\"]"
    - path: "src/angular/src/app/pages/files/file-options.component.scss"
      provides: "Dropdown styling without custom placeholders"
      not_contains: ["%dropdown", "%toggle"]
    - path: "src/angular/src/app/pages/files/file-options.component.html"
      provides: "Bootstrap dropdown with dark theme attribute"
      contains: "data-bs-theme"
    - path: "src/angular/src/app/pages/files/file-options.component.ts"
      provides: "Scroll listener for close-on-scroll behavior"
      contains: "scroll"
  key_links:
    - from: "file-options.component.html"
      to: "_bootstrap-overrides.scss"
      via: "data-bs-theme=\"dark\" attribute triggers CSS variable overrides"
      pattern: "data-bs-theme.*dark"
    - from: "file-options.component.ts"
      to: "bootstrap.Dropdown"
      via: "getInstance and hide() to close dropdowns on scroll"
      pattern: "bootstrap\\.Dropdown"
---

<objective>
Migrate file options dropdowns from custom SCSS placeholders to Bootstrap's native dropdown component with dark theme styling and close-on-scroll behavior.

Purpose: Removes 150+ lines of custom SCSS placeholder code (`%dropdown`, `%toggle`) in favor of Bootstrap's built-in dropdown functionality. Achieves requirement DROP-01 through DROP-03.

Output: File options dropdowns (Status filter, Sort filter) using Bootstrap's native component with correct positioning, dark theme styling, and proper close behavior.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-dropdown-migration/06-CONTEXT.md
@.planning/phases/06-dropdown-migration/06-RESEARCH.md

# Key source files
@src/angular/src/app/pages/files/file-options.component.scss
@src/angular/src/app/pages/files/file-options.component.html
@src/angular/src/app/pages/files/file-options.component.ts
@src/angular/src/app/common/_bootstrap-overrides.scss
@src/angular/src/app/common/_bootstrap-variables.scss
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Bootstrap dark dropdown theme overrides</name>
  <files>src/angular/src/app/common/_bootstrap-overrides.scss</files>
  <action>
Add CSS variable overrides for Bootstrap's dark dropdown theme. This enables any dropdown with `data-bs-theme="dark"` to use the app's color scheme.

Add to `_bootstrap-overrides.scss`:

```scss
// Dark dropdown theme (for file options dropdowns)
// Uses CSS variables so components only need data-bs-theme="dark" attribute
[data-bs-theme="dark"] {
  .dropdown-menu {
    // Background and border
    --bs-dropdown-bg: #{$primary-color};
    --bs-dropdown-border-color: #{$primary-dark-color};
    --bs-dropdown-box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.3);

    // Item colors
    --bs-dropdown-link-color: white;
    --bs-dropdown-link-hover-color: white;
    --bs-dropdown-link-hover-bg: #{$secondary-dark-color};
    --bs-dropdown-link-active-color: white;
    --bs-dropdown-link-active-bg: #{$secondary-dark-color};
    --bs-dropdown-link-disabled-color: rgba(white, 0.65);
  }

  // Toggle button pressed/open state
  .dropdown-toggle.show {
    background-color: $secondary-dark-color;
    border-color: $secondary-darker-color;
  }
}

// Dropdown item hover transition
.dropdown-item {
  transition: background-color 0.1s ease-in-out;
}
```

Import `_bootstrap-variables.scss` at the top of the file to access color variables:
```scss
@import 'bootstrap-variables';
```

Note: The file already has modal body overrides - add the dropdown overrides below them.
  </action>
  <verify>
Run Angular build to verify SCSS compiles without errors:
```bash
cd src/angular && npm run build 2>&1 | head -50
```
No SCSS compilation errors related to undefined variables.
  </verify>
  <done>
`_bootstrap-overrides.scss` contains dark dropdown theme CSS variable overrides using app color variables. File compiles successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Migrate dropdown HTML and remove SCSS placeholders</name>
  <files>
    src/angular/src/app/pages/files/file-options.component.html
    src/angular/src/app/pages/files/file-options.component.scss
  </files>
  <action>
**HTML changes** in `file-options.component.html`:

1. Add `data-bs-theme="dark"` attribute to both dropdown containers (`#filter-status` and `#sort-status`):
   ```html
   <div id="filter-status" class="dropdown" data-bs-theme="dark">
   ```
   ```html
   <div id="sort-status" class="dropdown" data-bs-theme="dark">
   ```

2. Add `dropdown-menu-end` class to both dropdown menus for right-aligned positioning:
   ```html
   <div class="dropdown-menu dropdown-menu-end">
   ```

**SCSS changes** in `file-options.component.scss`:

1. **DELETE the entire `%dropdown` placeholder** (lines 3-104, approximately). This includes:
   - The `button` styles
   - The `.dropdown-menu` styles
   - The `.icon` styles with image filters
   - All nested selectors

2. **DELETE the entire `%toggle` placeholder** (lines 107-154, approximately). This includes:
   - The background, border, color styles
   - The active/hover states
   - The `.selection` styles

3. **Update `#filter-status` section** - remove `@extend %dropdown;` and keep only the specific overrides needed for this dropdown:
   ```scss
   #filter-status {
       .selection {
           .sel-item {
               &#sel-item-all {
                   .icon {
                       display: none;
                   }
                   .text {
                       display: inherit;
                       margin-left: 0;
                   }
               }
           }
       }

       .icon {
           img {
               &.downloaded,
               &.downloading {
                   width: 20px;
               }
               &.stopped {
                   width: 13px;
               }
           }
       }
   }
   ```

4. **Update `#sort-status` section** - remove `@extend %dropdown;`. If the section becomes empty (just `@extend`), remove it entirely.

5. **Update `#toggle-details` section** - remove `@extend %toggle;` and keep specific overrides:
   ```scss
   #toggle-details {
       .selection {
           .sel-item {
               .icon {
                   display: none;
               }
               .text {
                   margin-left: 0;
               }
           }
       }
   }
   ```

6. **Update `#pin-filter` section** - remove `@extend %toggle;` and add explicit sizing:
   ```scss
   #pin-filter {
       width: 20px;
       height: 20px;
       padding: 0;

       display: flex;
       flex-direction: row;
       align-items: center;
       justify-content: center;
   }
   ```

7. **Update media query** - remove `%dropdown` override in the `@media` block (lines 300-312). The responsive text display is now handled by Bootstrap's default dropdown behavior.

8. **Add necessary dropdown styling** that was in the placeholder but needed for the component's specific layout:
   ```scss
   // Dropdown button and menu styling
   #filter-status,
   #sort-status {
       button {
           height: 34px;
           cursor: default;
           user-select: none;

           display: flex;
           flex-direction: row;
           align-items: center;
           flex-wrap: nowrap;

           .title {
               white-space: nowrap;
           }

           .selection {
               margin-left: 5px;

               .sel-item {
                   display: flex;
                   flex-direction: row;
                   align-items: center;
                   flex-wrap: nowrap;

                   .icon {
                       width: 20px;
                       height: 20px;
                       display: flex;
                       align-items: center;
                       justify-content: center;
                   }
                   .text {
                       margin-left: 5px;
                   }
               }
           }
       }

       .dropdown-menu {
           padding: 0;
           cursor: default;
           user-select: none;

           .dropdown-item {
               height: 32px;

               display: flex;
               flex-direction: row;
               align-items: center;
               flex-wrap: nowrap;

               .icon {
                   width: 20px;
                   height: 20px;
                   display: flex;
                   align-items: center;
                   justify-content: center;
               }
               .text {
                   margin-left: 5px;
               }
           }
       }

       // Icon image styling (applies to both button and menu)
       .icon img {
           width: 15px;
           height: 15px;
           filter: invert(1.0);
           margin-top: -2px;
       }
   }

   // Toggle button styling (#toggle-details and #pin-filter)
   #toggle-details {
       height: 34px;
       cursor: default;
       user-select: none;

       display: flex;
       flex-direction: row;
       align-items: center;
       flex-wrap: nowrap;

       .title {
           white-space: nowrap;
       }

       .selection {
           margin-left: 5px;

           .sel-item {
               display: flex;
               flex-direction: row;
               align-items: center;
               flex-wrap: nowrap;
           }
       }
   }
   ```

9. **Keep responsive media query** for text display on larger screens, but update to target the specific elements:
   ```scss
   @media only screen and (min-width: $medium-min-width) {
       #filter-status,
       #sort-status {
           button .selection .sel-item .text {
               display: inherit;
           }
       }
   }
   ```

Note: The `#toggle-details` and `#pin-filter` buttons are not dropdowns - they're simple toggle buttons that already use Bootstrap's `btn` classes. They just need the layout styles that were in `%toggle`.
  </action>
  <verify>
1. Build Angular to verify SCSS compiles:
```bash
cd src/angular && npm run build 2>&1 | head -50
```

2. Verify no `%dropdown` or `%toggle` placeholders remain:
```bash
grep -n "%dropdown\|%toggle" src/angular/src/app/pages/files/file-options.component.scss
```
Should return no results.

3. Run Angular unit tests to ensure no regressions:
```bash
cd src/angular && npm test -- --watch=false 2>&1 | tail -20
```
  </verify>
  <done>
- HTML has `data-bs-theme="dark"` on dropdown containers
- HTML has `dropdown-menu-end` on dropdown menus
- SCSS has no `%dropdown` or `%toggle` placeholders
- SCSS compiles without errors
- Unit tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Add close-on-scroll behavior</name>
  <files>src/angular/src/app/pages/files/file-options.component.ts</files>
  <action>
Add scroll event listener to close any open dropdowns when user scrolls. This prevents orphaned dropdowns when scrolling the file list.

1. Add `NgZone` to imports and constructor:
   ```typescript
   import {ChangeDetectionStrategy, ChangeDetectorRef, Component, NgZone, OnDestroy, OnInit} from "@angular/core";
   ```

2. Add Bootstrap type declaration at the top of the file (after imports):
   ```typescript
   declare var bootstrap: any;
   ```

3. Update constructor to inject NgZone:
   ```typescript
   constructor(private _changeDetector: ChangeDetectorRef,
               private viewFileOptionsService: ViewFileOptionsService,
               private _viewFileService: ViewFileService,
               private _domService: DomService,
               private _ngZone: NgZone) {
   ```

4. Add scroll handler as a class property (arrow function to preserve `this` binding):
   ```typescript
   private scrollHandler = () => {
       const openToggles = document.querySelectorAll('.dropdown-toggle.show');
       openToggles.forEach(toggle => {
           const dropdownInstance = bootstrap.Dropdown.getInstance(toggle);
           if (dropdownInstance) {
               dropdownInstance.hide();
           }
       });
   };
   ```

5. Add scroll listener setup in `ngOnInit()`:
   ```typescript
   // Close dropdowns on scroll to prevent orphaned menus
   this._ngZone.runOutsideAngular(() => {
       window.addEventListener('scroll', this.scrollHandler, { passive: true });
   });
   ```

6. Add scroll listener cleanup in `ngOnDestroy()`:
   ```typescript
   window.removeEventListener('scroll', this.scrollHandler);
   ```

The `runOutsideAngular` is used for performance - scroll events fire frequently and don't need to trigger Angular change detection.
  </action>
  <verify>
1. Run Angular unit tests:
```bash
cd src/angular && npm test -- --watch=false 2>&1 | tail -20
```

2. Run ESLint to check for TypeScript issues:
```bash
cd src/angular && npm run lint 2>&1 | tail -20
```

3. Build to verify compilation:
```bash
cd src/angular && npm run build 2>&1 | tail -20
```
  </verify>
  <done>
- TypeScript compiles without errors
- Scroll listener added in ngOnInit
- Scroll listener removed in ngOnDestroy
- Unit tests pass
- ESLint passes
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Build verification:**
   ```bash
   cd src/angular && npm run build
   ```
   Build completes without errors.

2. **Unit test verification:**
   ```bash
   cd src/angular && npm test -- --watch=false
   ```
   All 387 tests pass.

3. **Lint verification:**
   ```bash
   cd src/angular && npm run lint
   ```
   No lint errors.

4. **Placeholder removal verification:**
   ```bash
   grep -rn "%dropdown\|%toggle" src/angular/src/app/
   ```
   Returns no results - all custom placeholders removed.

5. **Dark theme attribute verification:**
   ```bash
   grep -n "data-bs-theme" src/angular/src/app/pages/files/file-options.component.html
   ```
   Shows `data-bs-theme="dark"` on both dropdown containers.
</verification>

<success_criteria>
- [ ] Angular builds without SCSS or TypeScript errors
- [ ] All 387 unit tests pass
- [ ] ESLint passes with no errors
- [ ] No `%dropdown` or `%toggle` SCSS placeholders exist in codebase
- [ ] `data-bs-theme="dark"` attribute present on dropdown containers
- [ ] `dropdown-menu-end` class present on dropdown menus
- [ ] Scroll listener implemented for close-on-scroll behavior
- [ ] DROP-01, DROP-02, DROP-03 requirements addressed
</success_criteria>

<output>
After completion, create `.planning/phases/06-dropdown-migration/06-01-SUMMARY.md`
</output>
