# Plan 02-03: Reservation Management UI + Point Availability UI

**Phase:** 2 -- Calculations & Reservations
**Goal:** User can manage reservations and view point availability through the browser -- completing the full Phase 2 experience where all calculations and reservation tracking are usable end-to-end.
**Requirements:** TRIP-01 (UI), TRIP-03 (UI), TRIP-04 (UI), TRIP-05 (UI integration), PNTS-04 (UI), PNTS-05 (UI), PNTS-06 (UI)
**Depends on:** Plan 02-02 (Reservation API, Availability API)

## Context

Plans 02-01 and 02-02 built the data model, calculation engine, and API layer. This plan creates the React frontend for reservation management and point availability visualization.

Existing frontend infrastructure to build on:
- `frontend/src/pages/ContractsPage.tsx` -- Pattern for page layout with card grid
- `frontend/src/components/ContractCard.tsx` -- Pattern for expandable cards with action buttons
- `frontend/src/components/ContractFormDialog.tsx` -- Pattern for create/edit dialog forms
- `frontend/src/components/StayCostCalculator.tsx` -- Existing cost calculator with date pickers and room selector (reusable for reservation cost lookup)
- `frontend/src/hooks/useContracts.ts` -- Pattern for TanStack Query hooks with cache invalidation
- `frontend/src/types/index.ts` -- Existing TypeScript types
- `frontend/src/lib/api.ts` -- Fetch wrapper with error handling
- `frontend/src/components/Layout.tsx` -- Sidebar navigation

This plan adds two new pages to the sidebar navigation:
1. **Reservations** -- List, create, edit, and cancel reservations
2. **Point Calculator** -- Pick a date, see available points across all contracts

## Tasks

### 1. Reservation management page + components

**File(s):**
- `frontend/src/pages/ReservationsPage.tsx` (new)
- `frontend/src/components/ReservationCard.tsx` (new)
- `frontend/src/components/ReservationFormDialog.tsx` (new)
- `frontend/src/hooks/useReservations.ts` (new)
- `frontend/src/types/index.ts` (extend)
- `frontend/src/lib/api.ts` (extend if needed)

**Action:** Build the complete reservation management UI.

**Add to `frontend/src/types/index.ts`:**
```typescript
export type ReservationStatus = "confirmed" | "pending" | "cancelled";

export interface Reservation {
  id: number;
  contract_id: number;
  resort: string;
  room_key: string;
  check_in: string;  // ISO date
  check_out: string;
  points_cost: number;
  status: ReservationStatus;
  confirmation_number: string | null;
  notes: string | null;
  created_at: string;
  updated_at: string;
}

export interface AvailabilityContractResult {
  contract_id: number;
  contract_name: string;
  home_resort: string;
  annual_points: number;
  use_year: number;
  use_year_start: string;
  use_year_end: string;
  use_year_status: string;
  banking_deadline: string;
  banking_deadline_passed: boolean;
  days_until_banking_deadline: number;
  days_until_expiration: number;
  balances: Record<string, number>;
  total_points: number;
  committed_points: number;
  committed_reservation_count: number;
  available_points: number;
}

export interface AvailabilitySummary {
  total_contracts: number;
  total_points: number;
  total_committed: number;
  total_available: number;
}

export interface AvailabilityResponse {
  target_date: string;
  contracts: AvailabilityContractResult[];
  summary: AvailabilitySummary;
}
```

**`frontend/src/hooks/useReservations.ts`:** TanStack Query hooks:
```typescript
export function useReservations(filters?: { contractId?: number; status?: string; upcoming?: boolean })
// GET /api/reservations with optional query params

export function useContractReservations(contractId: number)
// GET /api/contracts/{contractId}/reservations

export function useCreateReservation()
// POST /api/contracts/{contractId}/reservations -- mutation with invalidation of ["reservations"]

export function useUpdateReservation()
// PUT /api/reservations/{id} -- mutation with invalidation

export function useDeleteReservation()
// DELETE /api/reservations/{id} -- mutation with invalidation
```

Invalidate both `["reservations"]` and `["availability"]` query keys on mutations, since reservation changes affect availability calculations.

**`frontend/src/pages/ReservationsPage.tsx`:**
- Header: "Reservations" title with "Add Reservation" button
- Filter bar: status filter (All / Confirmed / Pending / Cancelled), toggle for "Upcoming only"
- List of ReservationCard components, sorted by check_in date (nearest first for upcoming, most recent first for past)
- Empty state: "No reservations yet. Add your first reservation to track your DVC bookings."
- Responsive grid: 1 col mobile, 2 cols desktop

**`frontend/src/components/ReservationCard.tsx`:** Card showing:
- Resort name (human-readable, resolved from resort slug using resorts data)
- Room type (human-readable, parsed from room_key -- reuse the parsing logic from point charts)
- Check-in / Check-out dates formatted with date-fns (e.g., "Mar 15 - 20, 2026")
- Number of nights (calculated from dates)
- Points cost (e.g., "85 points")
- Status badge: "Confirmed" (green), "Pending" (amber), "Cancelled" (gray with strikethrough on points)
- Confirmation number (if present)
- Contract name/resort (which contract this reservation is charged to)
- Action buttons: Edit (pencil icon), Cancel (updates status to "cancelled"), Delete (trash icon, with confirmation dialog)

**`frontend/src/components/ReservationFormDialog.tsx`:** Dialog for creating/editing reservations:
- Fields:
  - Contract selector (dropdown of user's contracts -- from useContracts hook)
  - Resort selector (filtered to eligible resorts for the selected contract -- uses the contract's eligible_resorts from the API)
  - Room type selector (populated from resort's room_types and view_categories from resorts data)
  - Check-in date (date input)
  - Check-out date (date input, must be after check-in)
  - Points cost (number input -- manual entry)
  - Status (select: Confirmed / Pending)
  - Confirmation number (optional text input)
  - Notes (optional textarea)
- "Calculate Cost" button: When resort, room, and dates are filled in, the user can click this to call the existing `POST /api/point-charts/calculate` endpoint and auto-populate the points_cost field. Show the result inline (total points + nightly breakdown). This reuses the existing backend cost calculator -- no new endpoint needed.
- Validation: resort must be in contract's eligible resorts, check_out after check_in, points > 0
- On submit: POST or PUT to API, close dialog, invalidate queries

### 2. Point availability calculator page + components

**File(s):**
- `frontend/src/pages/AvailabilityPage.tsx` (new)
- `frontend/src/components/AvailabilityCard.tsx` (new)
- `frontend/src/hooks/useAvailability.ts` (new)

**Action:** Build the point availability visualization.

**`frontend/src/hooks/useAvailability.ts`:**
```typescript
export function useAvailability(targetDate: string | null) {
  return useQuery({
    queryKey: ["availability", targetDate],
    queryFn: () => api.get<AvailabilityResponse>(`/availability?target_date=${targetDate}`),
    enabled: !!targetDate,  // don't fetch until a date is selected
  });
}
```

**`frontend/src/pages/AvailabilityPage.tsx`:**
- Header: "Point Availability" title
- Date picker input (defaults to today's date)
- "Check Availability" button (or auto-query on date change with debounce)
- Results section (shown after querying):
  - **Summary banner** at the top:
    - Large number: total available points (e.g., "275 points available")
    - Subtitle: "across {n} contracts on {date}"
    - Breakdown: "{total} total - {committed} committed = {available} available"
  - **Per-contract cards** (using AvailabilityCard component):
    - One card per contract, showing the breakdown for that contract

**`frontend/src/components/AvailabilityCard.tsx`:** Card for a single contract's availability:
- Header: Contract name + home resort
- Use year indicator: "2025 Use Year (Jun 2025 - May 2026)" with status badge
- Point balances breakdown:
  - Current: 160 pts
  - Banked: 45 pts
  - Borrowed: 0 pts
  - Holding: 0 pts
  - **Total: 205 pts**
- Committed points: "- 85 pts (1 reservation)" in red/amber
- **Available: 120 pts** in large green text
- Banking deadline section:
  - If not passed: "Banking deadline: Jan 31, 2027 (in 325 days)" in green
  - If approaching (<30 days): same but in amber with warning icon
  - If passed: "Banking deadline passed (40 days ago)" in red
- Expiration: "Points expire: May 31, 2026 (in 110 days)"

### 3. Navigation + routing + cross-feature integration

**File(s):**
- `frontend/src/App.tsx` (add routes)
- `frontend/src/components/Layout.tsx` (add nav links)
- `frontend/src/components/ContractCard.tsx` (extend with reservation count)

**Action:** Wire the new pages into navigation and add cross-feature integration.

**`frontend/src/App.tsx`:** Add routes:
- `/reservations` -> ReservationsPage
- `/availability` -> AvailabilityPage

**`frontend/src/components/Layout.tsx`:** Add sidebar navigation items:
- Contracts (existing)
- Reservations (new -- with icon)
- Point Calculator (new -- links to /availability)
- Point Charts (existing)

Order the nav items by workflow: Contracts first (setup), then Point Calculator (planning), then Reservations (tracking), then Point Charts (reference).

**`frontend/src/components/ContractCard.tsx`:** Extend the existing contract card to show:
- Reservation count: "2 upcoming reservations" or "No reservations" below the point balance summary
- Points committed to reservations: show as a deduction in the point summary if reservations exist
- This requires adding `useContractReservations(contractId)` to the card (only fetched when card is expanded, to avoid excessive API calls)

## Verification

1. **Reservation management flow:**
   - Visit http://localhost:5173/reservations
   - See empty state: "No reservations yet"
   - Click "Add Reservation" -> dialog opens
   - Select a contract -> resort dropdown filters to eligible resorts
   - Select Polynesian, Deluxe Studio Standard View
   - Enter check-in Mar 15, check-out Mar 20
   - Click "Calculate Cost" -> points_cost auto-populates (e.g., 85 points)
   - Submit -> reservation card appears with all details
   - Edit: change dates -> points update
   - Cancel: status changes to "Cancelled", card shows grey with strikethrough

2. **Point availability flow:**
   - Visit http://localhost:5173/availability
   - Date defaults to today
   - See per-contract breakdown cards
   - Each card shows point balances, committed points, available total
   - Banking deadline status shows with appropriate color coding
   - Change date -> results update
   - Add a reservation -> return to availability -> committed points increased, available decreased

3. **Navigation:**
   - All 4 nav items visible in sidebar: Contracts, Point Calculator, Reservations, Point Charts
   - All routes work without 404

4. **Cross-feature integration:**
   - Contract card shows reservation count when expanded
   - Reservation changes reflected in availability calculations

5. **Frontend builds clean:**
   ```bash
   cd frontend && npx tsc --noEmit  # No TypeScript errors
   npm run build  # Vite build succeeds
   ```

## Notes

- The "Calculate Cost" button in the reservation form reuses the existing `POST /api/point-charts/calculate` endpoint. No new backend work needed -- the cost calculator was built in Phase 1 (Plan 01-03). If point chart data doesn't exist for the selected resort/year, the button shows an appropriate message ("Point chart not available for this resort/year").
- Resort/room names are resolved client-side using the resorts data from `/api/resorts`. The room_key parsing logic (splitting "deluxe_studio_lake" into room type + view category) should be extracted into a shared utility function in `frontend/src/lib/utils.ts` since it's now used by both StayCostCalculator and ReservationCard.
- The availability page queries on every date change. TanStack Query's caching prevents redundant requests when toggling back to a previously-queried date.
- Reservation mutations invalidate both `["reservations"]` and `["availability"]` query keys so the availability page stays in sync without manual refresh.
- The filter bar on the reservations page uses URL query params for shareable state (e.g., `/reservations?status=confirmed&upcoming=true`). This is optional but follows best practices for filter UIs.
