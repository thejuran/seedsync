---
phase: 25-auto-delete-with-safety
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/python/common/config.py
  - src/python/seedsync.py
  - src/angular/src/app/services/settings/config.ts
  - src/angular/src/app/pages/settings/options-list.ts
  - src/angular/src/app/pages/settings/settings-page.component.html
  - src/angular/src/app/pages/settings/settings-page.component.ts
autonomous: true

must_haves:
  truths:
    - "Config.AutoDelete section is parsed from config file with enabled, dry_run, delay_seconds"
    - "Missing AutoDelete section in config file does not break backward compatibility"
    - "Default config creates AutoDelete with enabled=False, dry_run=False, delay_seconds=60"
    - "Frontend settings page shows Auto-Delete section with 3 controls"
    - "User can toggle auto-delete enabled, dry-run, and change delay via settings UI"
  artifacts:
    - path: "src/python/common/config.py"
      provides: "Config.AutoDelete InnerConfig section"
      contains: "class AutoDelete"
    - path: "src/python/seedsync.py"
      provides: "Default AutoDelete config values"
      contains: "config.autodelete"
    - path: "src/angular/src/app/services/settings/config.ts"
      provides: "IAutoDelete interface and Record"
      contains: "IAutoDelete"
    - path: "src/angular/src/app/pages/settings/options-list.ts"
      provides: "OPTIONS_CONTEXT_AUTODELETE constant"
      contains: "OPTIONS_CONTEXT_AUTODELETE"
    - path: "src/angular/src/app/pages/settings/settings-page.component.html"
      provides: "Auto-Delete accordion card in settings"
      contains: "autodelete"
  key_links:
    - from: "src/python/common/config.py"
      to: "src/python/seedsync.py"
      via: "Config.AutoDelete used in default config creation"
      pattern: "config\\.autodelete\\."
    - from: "src/angular/src/app/pages/settings/options-list.ts"
      to: "src/angular/src/app/pages/settings/settings-page.component.html"
      via: "OPTIONS_CONTEXT_AUTODELETE referenced in template"
      pattern: "OPTIONS_CONTEXT_AUTODELETE"
    - from: "src/angular/src/app/services/settings/config.ts"
      to: "src/angular/src/app/pages/settings/settings-page.component.html"
      via: "config async pipe reads autodelete section"
      pattern: "autodelete"
---

<objective>
Add Config.AutoDelete section (backend + frontend) so auto-delete settings can be persisted and controlled via the Settings UI.

Purpose: Foundation config layer that Plan 02 reads to determine auto-delete behavior. Users need settings controls before the feature does anything.
Output: Config.AutoDelete InnerConfig, frontend IAutoDelete Record, settings page UI section with enable/dry-run/delay controls.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-auto-delete-with-safety/25-RESEARCH.md
@src/python/common/config.py
@src/python/seedsync.py
@src/angular/src/app/services/settings/config.ts
@src/angular/src/app/pages/settings/options-list.ts
@src/angular/src/app/pages/settings/settings-page.component.html
@src/angular/src/app/pages/settings/settings-page.component.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Config.AutoDelete InnerConfig section and default values</name>
  <files>src/python/common/config.py, src/python/seedsync.py</files>
  <action>
In `src/python/common/config.py`:

1. Add `Config.AutoDelete` class after `Config.Sonarr`, following the exact same InnerConfig pattern:
   ```python
   class AutoDelete(IC):
       enabled = PROP("enabled", Checkers.null, Converters.bool)
       dry_run = PROP("dry_run", Checkers.null, Converters.bool)
       delay_seconds = PROP("delay_seconds", Checkers.int_positive, Converters.int)

       def __init__(self):
           super().__init__()
           self.enabled = None
           self.dry_run = None
           self.delay_seconds = None
   ```
   - Uses `Checkers.null` for enabled and dry_run (same as Sonarr.enabled -- validation at usage, not parse)
   - Uses `Checkers.int_positive` for delay_seconds (delay must be > 0)
   - Uses `Converters.bool` for enabled/dry_run, `Converters.int` for delay_seconds

2. In `Config.__init__`, add after `self.sonarr`:
   ```python
   self.autodelete = Config.AutoDelete()
   ```

3. In `Config.from_dict`, add after the Sonarr optional block (before `_check_empty_outer_dict`):
   ```python
   # AutoDelete section is optional for backward compatibility
   if "AutoDelete" in config_dict:
       config.autodelete = Config.AutoDelete.from_dict(
           Config._check_section(config_dict, "AutoDelete")
       )
   ```
   This follows the exact same backward-compatibility pattern as Sonarr.

4. In `Config.as_dict`, add after the Sonarr line:
   ```python
   config_dict["AutoDelete"] = self.autodelete.as_dict()
   ```

In `src/python/seedsync.py`:

5. In `_create_default_config`, add after the sonarr block (before `return config`):
   ```python
   config.autodelete.enabled = False
   config.autodelete.dry_run = False
   config.autodelete.delay_seconds = 60
   ```
   - enabled=False: Opt-in feature, user must explicitly enable (per research recommendation)
   - dry_run=False: When user enables, it actually deletes (dry_run is separate safety toggle)
   - delay_seconds=60: Default 60-second safety delay
  </action>
  <verify>
Run `cd /Users/julianamacbook/seedsync/src/python && poetry run python -c "from common import Config; c = Config(); c.autodelete.enabled = False; c.autodelete.dry_run = False; c.autodelete.delay_seconds = 60; print(c.as_dict()['AutoDelete']); s = c.to_str(); c2 = Config.from_str(s); print('roundtrip ok:', c2.autodelete.enabled == False and c2.autodelete.delay_seconds == 60)"` -- should print the dict and "roundtrip ok: True".

Also verify backward compatibility: `cd /Users/julianamacbook/seedsync/src/python && poetry run python -c "from common import Config; d = {'General': {'debug': 'False', 'verbose': 'False'}, 'Lftp': {'remote_address': 'x', 'remote_username': 'x', 'remote_password': 'x', 'remote_port': '22', 'remote_path': '/tmp', 'local_path': '/tmp', 'remote_path_to_scan_script': '/tmp', 'use_ssh_key': 'False', 'num_max_parallel_downloads': '2', 'num_max_parallel_files_per_download': '4', 'num_max_connections_per_root_file': '4', 'num_max_connections_per_dir_file': '4', 'num_max_total_connections': '16', 'use_temp_file': 'False'}, 'Controller': {'interval_ms_remote_scan': '30000', 'interval_ms_local_scan': '10000', 'interval_ms_downloading_scan': '1000', 'extract_path': '/tmp', 'use_local_path_as_extract_path': 'True', 'max_tracked_files': '10000'}, 'Web': {'port': '8800'}, 'AutoQueue': {'enabled': 'True', 'patterns_only': 'False', 'auto_extract': 'True'}}; c = Config.from_dict(d); print('backward compat ok:', c.autodelete.enabled is None)"` -- prints "backward compat ok: True" (no AutoDelete section in dict, defaults to None).
  </verify>
  <done>Config.AutoDelete InnerConfig class exists with 3 typed properties. Config round-trips through to_str/from_str. Old config files without AutoDelete section parse without error (backward compatible). Default config has enabled=False, dry_run=False, delay_seconds=60.</done>
</task>

<task type="auto">
  <name>Task 2: Add frontend AutoDelete config model and settings UI section</name>
  <files>src/angular/src/app/services/settings/config.ts, src/angular/src/app/pages/settings/options-list.ts, src/angular/src/app/pages/settings/settings-page.component.html, src/angular/src/app/pages/settings/settings-page.component.ts</files>
  <action>
In `src/angular/src/app/services/settings/config.ts`:

1. Add IAutoDelete interface and Record after the Sonarr block (before the CONFIG section):
   ```typescript
   /*
    * AUTODELETE
    */
   interface IAutoDelete {
       enabled: boolean;
       dry_run: boolean;
       delay_seconds: number;
   }
   const DefaultAutoDelete: IAutoDelete = {
       enabled: null,
       dry_run: null,
       delay_seconds: null,
   };
   const AutoDeleteRecord = Record(DefaultAutoDelete);
   ```

2. Add `autodelete: IAutoDelete;` to the `IConfig` interface.

3. Add `autodelete: null,` to `DefaultConfig`.

4. In the `Config` class, add `autodelete: IAutoDelete;` field.

5. In the `Config` constructor, add to the `super()` call:
   ```typescript
   autodelete: props.autodelete ? AutoDeleteRecord(props.autodelete) : AutoDeleteRecord(DefaultAutoDelete),
   ```
   This follows the same backward-compatible pattern as `sonarr` -- falls back to defaults if section missing.

In `src/angular/src/app/pages/settings/options-list.ts`:

6. Add the OPTIONS_CONTEXT_AUTODELETE constant after OPTIONS_CONTEXT_EXTRACT:
   ```typescript
   export const OPTIONS_CONTEXT_AUTODELETE: IOptionsContext = {
       header: "Auto-Delete After Import",
       id: "autodelete",
       options: [
           {
               type: OptionType.Checkbox,
               label: "Enable auto-delete",
               valuePath: ["autodelete", "enabled"],
               description: "Automatically delete local files after Sonarr import"
           },
           {
               type: OptionType.Checkbox,
               label: "Dry-run mode",
               valuePath: ["autodelete", "dry_run"],
               description: "Log what would be deleted without actually deleting"
           },
           {
               type: OptionType.Text,
               label: "Safety delay (seconds)",
               valuePath: ["autodelete", "delay_seconds"],
               description: "Wait this long after import detection before deleting (default: 60)"
           }
       ]
   };
   ```

In `src/angular/src/app/pages/settings/settings-page.component.ts`:

7. Import `OPTIONS_CONTEXT_AUTODELETE` in the import statement (add to the existing destructured import from `./options-list`).

8. Add the public property: `public OPTIONS_CONTEXT_AUTODELETE = OPTIONS_CONTEXT_AUTODELETE;`

In `src/angular/src/app/pages/settings/settings-page.component.html`:

9. Add the AutoDelete section AFTER the *arr Integration card and BEFORE the closing `</div>` of `#left`. Use the `#optionsList` template (NOT a custom card like *arr -- AutoDelete has no special controls like Test Connection):
   ```html
   <!--suppress HtmlUnknownAttribute, UnnecessaryLabelJS -->
   <ng-container
       *ngTemplateOutlet="optionsList;context:OPTIONS_CONTEXT_AUTODELETE">
   </ng-container>
   ```
   Place this after the *arr Integration closing `</div>` (the card div at line ~103) and before `</div>` of `#left`.
  </action>
  <verify>
Run `cd /Users/julianamacbook/seedsync/src/angular && node_modules/.bin/ng build --configuration=production 2>&1 | tail -5` -- should build without errors.

Also verify TypeScript compilation: `cd /Users/julianamacbook/seedsync/src/angular && node_modules/.bin/tsc --noEmit 2>&1 | head -20` -- should show no errors (or only pre-existing ones).
  </verify>
  <done>Frontend config.ts has IAutoDelete interface with 3 fields and backward-compatible Record. Settings page shows "Auto-Delete After Import" accordion section with enable toggle, dry-run checkbox, and delay text field. Angular builds without errors.</done>
</task>

</tasks>

<verification>
1. Python config roundtrip: Create Config with AutoDelete values, serialize to string, deserialize, verify values match
2. Backward compatibility: Parse old config dict without AutoDelete section -- no error, autodelete properties are None
3. Angular build: `ng build --configuration=production` succeeds
4. Settings UI: AutoDelete section appears in left column after *arr Integration
</verification>

<success_criteria>
- Config.AutoDelete class exists with enabled (bool), dry_run (bool), delay_seconds (int) properties
- Config.from_dict handles missing AutoDelete section (backward compatible)
- Default config: enabled=False, dry_run=False, delay_seconds=60
- Frontend IAutoDelete Record with backward-compatible constructor fallback
- Settings page "Auto-Delete After Import" section with 3 controls
- Angular production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/25-auto-delete-with-safety/25-01-SUMMARY.md`
</output>
