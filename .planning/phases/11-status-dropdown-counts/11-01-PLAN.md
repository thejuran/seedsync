---
phase: 11-status-dropdown-counts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/angular/src/app/pages/files/file-options.component.ts
  - src/angular/src/app/pages/files/file-options.component.html
autonomous: true

must_haves:
  truths:
    - "Each status option displays count in parentheses (e.g., 'Downloaded (5)')"
    - "'All' option shows total file count across all statuses"
    - "Counts refresh when dropdown is opened (not real-time)"
    - "Empty statuses show '(0)' count and are disabled"
    - "Counts use thousands separator for large numbers"
  artifacts:
    - path: "src/angular/src/app/pages/files/file-options.component.ts"
      provides: "Status count computation and formatting"
      contains: "computeStatusCounts"
    - path: "src/angular/src/app/pages/files/file-options.component.html"
      provides: "Count display in dropdown button and items"
      contains: "formatCount"
  key_links:
    - from: "file-options.component.ts"
      to: "_viewFileService.files"
      via: "on-demand computation triggered by dropdown show event"
      pattern: "show.bs.dropdown.*computeStatusCounts"
    - from: "file-options.component.html"
      to: "file-options.component.ts"
      via: "formatCount() method called in template interpolation"
      pattern: "formatCount\\("
---

<objective>
Add file counts to status dropdown options so users can see how many files are in each status category.

Purpose: Users need at-a-glance visibility into file distribution across statuses without manually counting or clicking through filters.
Output: Status dropdown displays counts like "Downloaded (5)", "All (42)" with proper formatting and disabled states for empty statuses.
</objective>

<execution_context>
@/Users/julianamacbook/.claude/get-shit-done/workflows/execute-plan.md
@/Users/julianamacbook/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-status-dropdown-counts/11-CONTEXT.md
@.planning/phases/11-status-dropdown-counts/11-RESEARCH.md
@src/angular/src/app/pages/files/file-options.component.ts
@src/angular/src/app/pages/files/file-options.component.html
@src/angular/src/app/services/files/view-file.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add on-demand count computation triggered by dropdown open</name>
  <files>src/angular/src/app/pages/files/file-options.component.ts</files>
  <action>
Modify file-options.component.ts to add status count tracking with ON-DEMAND computation (per CONTEXT.md: "Counts refresh when dropdown is opened, not real-time"):

1. Add a `statusCounts` property as `Map<ViewFile.Status | null, number>` initialized to empty Map
   - null key represents "All" count

2. Add a private `numberFormatter` property using `Intl.NumberFormat()` (browser default locale)

3. Add `computeStatusCounts` private method that:
   - Takes `files: Immutable.List<ViewFile>` parameter
   - Returns `Map<ViewFile.Status | null, number>`
   - Sets null key to `files.size` for "All" count
   - Iterates `Object.values(ViewFile.Status)` and counts files matching each status
   - Use single-pass approach: initialize all to 0, then forEach to increment

4. Add `formatCount(status: ViewFile.Status | null): string` public method that:
   - Gets count from `this.statusCounts.get(status) ?? 0`
   - Returns `this.numberFormatter.format(count)`

5. Add `getCount(status: ViewFile.Status | null): number` public method that:
   - Returns `this.statusCounts.get(status) ?? 0`
   - Used for disabled state checks in template

6. Add a private `statusDropdownShowHandler` arrow function property that:
   - Gets current files synchronously via `this._viewFileService.filesSnapshot` (add if not exists) or use `firstValueFrom(this._viewFileService.files.pipe(take(1)))`
   - Actually, simpler approach: store a reference to the latest files in the existing subscription (files are already subscribed for isStatusEnabled), then use that cached reference
   - Calls `this.statusCounts = this.computeStatusCounts(this._latestFiles);`
   - Calls `this._changeDetector.detectChanges();`

7. Add a private `_latestFiles` property of type `Immutable.List<ViewFile>` initialized to `Immutable.List()`

8. Update the existing `ngOnInit` subscription to also store files:
   - Add `this._latestFiles = files;` at the start of the subscription callback
   - Also compute initial counts: `this.statusCounts = this.computeStatusCounts(files);` (so button shows count before first dropdown open)
   - DO NOT continuously update counts in subscription - only store the files reference

9. In `ngOnInit`, add Bootstrap 5 dropdown event listener (run outside Angular zone for performance):
   ```typescript
   this._ngZone.runOutsideAngular(() => {
     const statusDropdown = document.getElementById('filter-status');
     if (statusDropdown) {
       statusDropdown.addEventListener('show.bs.dropdown', this.statusDropdownShowHandler);
     }
   });
   ```

10. In `ngOnDestroy`, remove the event listener:
    ```typescript
    const statusDropdown = document.getElementById('filter-status');
    if (statusDropdown) {
      statusDropdown.removeEventListener('show.bs.dropdown', this.statusDropdownShowHandler);
    }
    ```

IMPORTANT: The key difference from the original plan is that counts are computed:
- Once on initial load (so button displays a count)
- On every dropdown open (show.bs.dropdown event)
- NOT on every file change via subscription (that would be real-time)

This honors the user decision: "Counts refresh when dropdown is opened (not real-time)"
  </action>
  <verify>
Run `npm run lint` from src/angular - should pass with no new errors.
Run `npm test` from src/angular - existing tests should still pass.
  </verify>
  <done>
TypeScript compiles without errors. Component has statusCounts Map, formatCount() method returns formatted numbers, getCount() returns raw counts. Counts are computed on dropdown open, not continuously.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update HTML to display counts with disabled states</name>
  <files>src/angular/src/app/pages/files/file-options.component.html</files>
  <action>
Modify file-options.component.html to show counts in status dropdown:

1. In the dropdown BUTTON (selected option display), add counts after each status text:
   - Change `<span class="text">All</span>` to `<span class="text">All ({{ formatCount(null) }})</span>`
   - Change `<span class="text">Extracted</span>` to `<span class="text">Extracted ({{ formatCount(ViewFile.Status.EXTRACTED) }})</span>`
   - Same pattern for all 6 status options in the button's `.selection` div

2. In the dropdown MENU items, add counts after each status text:
   - Change `<span class="text">All</span>` to `<span class="text">All ({{ formatCount(null) }})</span>`
   - Change `<span class="text">Extracted</span>` to `<span class="text">Extracted ({{ formatCount(ViewFile.Status.EXTRACTED) }})</span>`
   - Same pattern for all 6 status options in the dropdown-menu

3. Add `aria-disabled` attribute for accessibility on status dropdown items (NOT "All"):
   - Add `[attr.aria-disabled]="getCount(ViewFile.Status.EXTRACTED) === 0 ? true : null"` to each status item
   - "All" item should NOT have aria-disabled (it's never disabled per user decision)

4. Update click handlers to prevent action on disabled items (except "All"):
   - Change `(click)="onFilterByStatus(ViewFile.Status.EXTRACTED)"`
   - To `(click)="getCount(ViewFile.Status.EXTRACTED) > 0 ? onFilterByStatus(ViewFile.Status.EXTRACTED) : null"`
   - "All" keeps simple `(click)="onFilterByStatus(null)"` (always clickable)

5. Keep existing `[class.disabled]` bindings - they already use `isStatusEnabled` which works correctly.
   Note: The existing disabled class logic uses `isExtractedStatusEnabled ? null : true` pattern.
   This is semantically equivalent to `getCount(status) === 0` but don't change it to minimize diff.

Format: "Label (N)" with single space before parenthesis per CONTEXT.md decisions.
  </action>
  <verify>
Run `npm test` from src/angular - all tests pass.
Run `npm start` from src/angular and visually verify:
1. Dropdown button shows selected status with count
2. Dropdown menu shows all statuses with counts
3. Zero-count statuses show "(0)" and are grayed out
4. Clicking disabled status does nothing
5. "All" is always clickable even if "(0)"
6. Counts refresh when dropdown is opened (change files, open dropdown, see updated counts)
  </verify>
  <done>
Dropdown displays counts in format "Status (N)" for both button and menu items. Zero-count statuses are visually disabled with aria-disabled. Click prevention works on disabled items. "All" remains always enabled.
  </done>
</task>

</tasks>

<verification>
1. `npm run lint` passes with zero errors
2. `npm test` passes (387 tests)
3. Visual verification:
   - Status dropdown button shows "All (N)" or "Downloaded (N)" etc.
   - Status dropdown menu shows all statuses with counts
   - Counts use comma thousands separator (e.g., "1,234")
   - Empty statuses show "(0)" and are grayed/disabled
   - Empty statuses cannot be clicked
   - "All" option is never disabled
4. Functional verification:
   - Counts reflect actual file distribution
   - Selecting a status filter works
   - Counts refresh when dropdown is opened (not continuously)
</verification>

<success_criteria>
- UX-01: Status dropdown shows file count per status (e.g., "Downloaded (5)") - SATISFIED
- UX-02: "All" option shows total file count - SATISFIED
- UX-03: Counts refresh when dropdown is opened (per CONTEXT.md decision) - SATISFIED
- Phase 11 success criteria from ROADMAP.md all met
</success_criteria>

<output>
After completion, create `.planning/phases/11-status-dropdown-counts/11-01-SUMMARY.md`
</output>
