---
phase: 04-docker-settings
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - backend/models/app_setting.py
  - backend/models/__init__.py
  - backend/db/migrations/env.py
  - backend/api/settings.py
  - backend/api/schemas.py
  - backend/api/points.py
  - backend/main.py
  - frontend/src/pages/SettingsPage.tsx
  - frontend/src/components/Layout.tsx
  - frontend/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can toggle borrowing policy between 100% and 50% via the Settings page in the UI"
    - "Borrowing policy caps borrowed points to the configured percentage of annual points on create/update"
    - "Settings survive container restarts (stored in SQLite, not memory)"
    - "Default borrowing policy is 100% (no restriction) on fresh install"
  artifacts:
    - path: "backend/models/app_setting.py"
      provides: "AppSetting SQLAlchemy model (key-value table)"
      contains: "class AppSetting"
    - path: "backend/api/settings.py"
      provides: "Settings CRUD API (GET /api/settings, PUT /api/settings/{key})"
      exports: ["router"]
    - path: "frontend/src/pages/SettingsPage.tsx"
      provides: "Settings page with borrowing policy toggle"
      min_lines: 30
  key_links:
    - from: "backend/api/points.py"
      to: "backend/models/app_setting.py"
      via: "Query borrowing_limit_pct on point balance create/update"
      pattern: "borrowing_limit_pct"
    - from: "backend/api/settings.py"
      to: "backend/models/app_setting.py"
      via: "CRUD operations on app_settings table"
      pattern: "AppSetting"
    - from: "backend/main.py"
      to: "backend/api/settings.py"
      via: "include_router(settings_router)"
      pattern: "settings_router"
    - from: "frontend/src/pages/SettingsPage.tsx"
      to: "/api/settings"
      via: "fetch GET and PUT calls"
      pattern: "api\\.get.*settings|api\\.put.*settings"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/SettingsPage.tsx"
      via: "Route path=/settings"
      pattern: "Route.*settings.*SettingsPage"
    - from: "frontend/src/components/Layout.tsx"
      to: "/settings"
      via: "NavLink in sidebar"
      pattern: "settings.*Settings"
---

<objective>
App settings system with configurable borrowing policy (CONF-01).

Purpose: Allow users to toggle the DVC borrowing policy between 100% (borrow up to full annual points) and 50% (borrow up to half) from the UI. This is a user-facing preference stored in the database, not an env var, so it survives container restarts and can be changed without redeploying.

Output: AppSetting model, migration with seed data, settings API endpoints, borrowing policy enforcement in point balance validation, and a Settings page in the frontend.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04/04-RESEARCH.md
@.planning/phases/04/04-01-SUMMARY.md
@backend/models/__init__.py
@backend/models/contract.py
@backend/api/schemas.py
@backend/api/points.py
@backend/main.py
@backend/db/migrations/env.py
@frontend/src/App.tsx
@frontend/src/components/Layout.tsx
@frontend/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: AppSetting model, migration, settings API, and borrowing policy enforcement</name>
  <files>
    backend/models/app_setting.py
    backend/models/__init__.py
    backend/db/migrations/env.py
    backend/api/settings.py
    backend/api/schemas.py
    backend/api/points.py
    backend/main.py
  </files>
  <action>
    **Create `backend/models/app_setting.py`** -- Simple key-value settings model:
    ```python
    from sqlalchemy import Column, String
    from backend.db.database import Base

    class AppSetting(Base):
        __tablename__ = "app_settings"

        key = Column(String, primary_key=True)
        value = Column(String, nullable=False)
    ```

    **Update `backend/models/__init__.py`** -- Add AppSetting export:
    - Add: `from backend.models.app_setting import AppSetting`
    - Keep all existing imports (Contract, PurchaseType, UseYearMonth, PointBalance, PointAllocationType, Reservation, ReservationStatus).

    **Update `backend/db/migrations/env.py`** -- Add AppSetting to imports:
    - On line 18, update the import to include AppSetting:
      ```python
      from backend.models import Contract, PointBalance, Reservation, AppSetting  # noqa: F401
      ```

    **Create Alembic migration** -- Run from project root:
    ```bash
    cd /Users/julianamacbook/dvc
    alembic revision -m "add_app_settings_table"
    ```
    Then edit the generated migration file to contain:
    ```python
    def upgrade() -> None:
        op.create_table('app_settings',
            sa.Column('key', sa.String(), nullable=False),
            sa.Column('value', sa.String(), nullable=False),
            sa.PrimaryKeyConstraint('key')
        )
        # Seed default borrowing policy
        op.execute("INSERT INTO app_settings (key, value) VALUES ('borrowing_limit_pct', '100')")

    def downgrade() -> None:
        op.drop_table('app_settings')
    ```
    Then run: `alembic upgrade head` to apply.

    **Add settings schemas to `backend/api/schemas.py`** -- Append to end of file:
    ```python
    # App Settings schemas

    class AppSettingResponse(BaseModel):
        key: str
        value: str

        model_config = {"from_attributes": True}

    class AppSettingUpdate(BaseModel):
        value: str
    ```

    **Create `backend/api/settings.py`** -- Settings CRUD:
    ```python
    from fastapi import APIRouter, Depends, HTTPException
    from sqlalchemy.ext.asyncio import AsyncSession
    from sqlalchemy import select

    from backend.db.database import get_db
    from backend.models.app_setting import AppSetting
    from backend.api.schemas import AppSettingResponse, AppSettingUpdate

    router = APIRouter(tags=["settings"])

    # Valid settings keys and their allowed values
    SETTINGS_SCHEMA = {
        "borrowing_limit_pct": {"allowed": ["50", "100"], "default": "100"},
    }

    @router.get("/api/settings", response_model=list[AppSettingResponse])
    async def get_all_settings(db: AsyncSession = Depends(get_db)):
        """Return all app settings as a list."""
        result = await db.execute(select(AppSetting))
        return result.scalars().all()

    @router.get("/api/settings/{key}", response_model=AppSettingResponse)
    async def get_setting(key: str, db: AsyncSession = Depends(get_db)):
        """Get a single setting by key."""
        result = await db.execute(select(AppSetting).where(AppSetting.key == key))
        setting = result.scalar_one_or_none()
        if not setting:
            raise HTTPException(status_code=404, detail=f"Setting '{key}' not found")
        return setting

    @router.put("/api/settings/{key}", response_model=AppSettingResponse)
    async def update_setting(key: str, data: AppSettingUpdate, db: AsyncSession = Depends(get_db)):
        """Update a setting value. Only known keys with valid values are accepted."""
        if key not in SETTINGS_SCHEMA:
            raise HTTPException(status_code=404, detail=f"Unknown setting '{key}'")

        schema = SETTINGS_SCHEMA[key]
        if data.value not in schema["allowed"]:
            raise HTTPException(
                status_code=422,
                detail=f"Invalid value '{data.value}' for '{key}'. Allowed: {schema['allowed']}"
            )

        result = await db.execute(select(AppSetting).where(AppSetting.key == key))
        setting = result.scalar_one_or_none()
        if not setting:
            # Auto-create if migration seed was missed
            setting = AppSetting(key=key, value=data.value)
            db.add(setting)
        else:
            setting.value = data.value

        await db.commit()
        await db.refresh(setting)
        return setting
    ```

    **Modify `backend/api/points.py`** -- Enforce borrowing policy on create and update:

    1. Add imports at top:
       ```python
       from backend.models.app_setting import AppSetting
       ```

    2. Create a helper function (add before the route handlers):
       ```python
       async def get_borrowing_limit_pct(db: AsyncSession) -> int:
           """Get the borrowing limit percentage from app settings."""
           result = await db.execute(
               select(AppSetting).where(AppSetting.key == "borrowing_limit_pct")
           )
           setting = result.scalar_one_or_none()
           return int(setting.value) if setting else 100
       ```

    3. In `create_point_balance` (the POST handler), replace the existing warning block (lines 107-115) with enforcement:
       ```python
       # Enforce borrowing policy
       if data.allocation_type == "borrowed":
           borrowing_limit_pct = await get_borrowing_limit_pct(db)
           max_borrowed = int(contract.annual_points * borrowing_limit_pct / 100)
           if data.points > max_borrowed:
               raise HTTPException(
                   status_code=422,
                   detail=(
                       f"Borrowed points ({data.points}) exceed borrowing limit "
                       f"({borrowing_limit_pct}% of {contract.annual_points} = {max_borrowed} points)"
                   ),
               )
       ```

    4. In `update_point_balance` (the PUT handler at line 129), add borrowing validation after fetching the balance and before updating. Need to also fetch the contract to know annual_points:
       ```python
       # If updating a borrowed balance, enforce borrowing policy
       if balance.allocation_type == "borrowed":
           contract_result = await db.execute(
               select(Contract).where(Contract.id == balance.contract_id)
           )
           contract = contract_result.scalar_one_or_none()
           if contract:
               borrowing_limit_pct = await get_borrowing_limit_pct(db)
               max_borrowed = int(contract.annual_points * borrowing_limit_pct / 100)
               if data.points > max_borrowed:
                   raise HTTPException(
                       status_code=422,
                       detail=(
                           f"Borrowed points ({data.points}) exceed borrowing limit "
                           f"({borrowing_limit_pct}% of {contract.annual_points} = {max_borrowed} points)"
                       ),
                   )
       ```

    **Modify `backend/main.py`** -- Register settings router:
    - Add import: `from backend.api.settings import router as settings_router`
    - Add `app.include_router(settings_router)` BEFORE the SPA mount (which must remain LAST). Place it after the existing `app.include_router(trip_explorer_router)` line.
  </action>
  <verify>
    ```bash
    cd /Users/julianamacbook/dvc
    source .venv/bin/activate
    # Run migration
    alembic upgrade head
    # Test settings API
    python -c "
    import asyncio
    from backend.db.database import async_session
    from backend.models.app_setting import AppSetting
    from sqlalchemy import select

    async def check():
        async with async_session() as db:
            result = await db.execute(select(AppSetting))
            settings = result.scalars().all()
            print(f'Settings count: {len(settings)}')
            for s in settings:
                print(f'  {s.key} = {s.value}')

    asyncio.run(check())
    "
    # Start server and test API
    uvicorn backend.main:app --port 8001 &
    sleep 3
    curl -s http://localhost:8001/api/settings | python3 -c "import sys,json; d=json.load(sys.stdin); print('Settings:', d)"
    curl -s http://localhost:8001/api/settings/borrowing_limit_pct | python3 -c "import sys,json; d=json.load(sys.stdin); assert d['value']=='100', f'Expected 100, got {d[\"value\"]}'; print('Default borrowing limit: 100%')"
    # Test toggle to 50%
    curl -s -X PUT http://localhost:8001/api/settings/borrowing_limit_pct -H "Content-Type: application/json" -d '{"value":"50"}' | python3 -c "import sys,json; d=json.load(sys.stdin); assert d['value']=='50'; print('Updated to 50%')"
    # Test borrowing enforcement: create a contract with 200 annual points, try to borrow 150 (should fail at 50%)
    curl -s -X POST http://localhost:8001/api/contracts -H "Content-Type: application/json" -d '{"home_resort":"polynesian","use_year_month":2,"annual_points":200,"purchase_type":"direct"}' > /tmp/contract.json
    CONTRACT_ID=$(python3 -c "import sys,json; print(json.load(open('/tmp/contract.json'))['id'])")
    curl -s -X POST "http://localhost:8001/api/contracts/${CONTRACT_ID}/points" -H "Content-Type: application/json" -d '{"use_year":2026,"allocation_type":"borrowed","points":150}' | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'detail' in d and 'exceed' in d['detail'], f'Should have been rejected: {d}'; print('Borrowing limit enforced: 150 > 100 (50% of 200)')"
    # Reset to 100% and verify same request succeeds
    curl -s -X PUT http://localhost:8001/api/settings/borrowing_limit_pct -H "Content-Type: application/json" -d '{"value":"100"}'
    curl -s -X POST "http://localhost:8001/api/contracts/${CONTRACT_ID}/points" -H "Content-Type: application/json" -d '{"use_year":2026,"allocation_type":"borrowed","points":150}' | python3 -c "import sys,json; d=json.load(sys.stdin); assert 'id' in d, f'Should have succeeded: {d}'; print('Borrowing at 100%: 150 of 200 allowed')"
    kill %1 2>/dev/null
    ```
  </verify>
  <done>
    - AppSetting model exists with key/value columns
    - Alembic migration creates app_settings table with default borrowing_limit_pct=100
    - GET /api/settings returns all settings
    - GET /api/settings/borrowing_limit_pct returns the current policy
    - PUT /api/settings/borrowing_limit_pct accepts "50" or "100" only
    - Borrowed point creation is rejected when points exceed (annual_points * limit_pct / 100)
    - Borrowed point update is also validated against the policy
    - Settings router registered in main.py before SPA mount
  </done>
</task>

<task type="auto">
  <name>Task 2: Frontend settings page with borrowing policy toggle</name>
  <files>
    frontend/src/pages/SettingsPage.tsx
    frontend/src/components/Layout.tsx
    frontend/src/App.tsx
  </files>
  <action>
    **Create `frontend/src/pages/SettingsPage.tsx`** -- Settings page with borrowing policy toggle:

    Build a simple settings page using the existing UI patterns from other pages (use the same card/section styling as ContractsPage or DashboardPage). The page should:

    1. Fetch current settings from `GET /api/settings` on mount (use `useQuery` from `@tanstack/react-query` with key `["settings"]`)
    2. Display a "Borrowing Policy" section with a clear toggle/selector between:
       - "100% - Borrow up to full annual points" (default)
       - "50% - Borrow up to half of annual points"
    3. On selection change, call `PUT /api/settings/borrowing_limit_pct` with `{"value": "100"}` or `{"value": "50"}`
    4. Use `useMutation` from react-query with `onSuccess` invalidating the `["settings"]` query
    5. Show the current policy value with a description of what it means
    6. Use existing UI components from `@/components/ui/` (Card, Button, or similar existing components)
    7. Use the `api` helper from `@/lib/api.ts` for all API calls (consistent with every other page)

    Implementation details:
    - Import `{ api }` from `@/lib/api`
    - Use `api.get<AppSetting[]>("/settings")` for fetching
    - Use `api.put<AppSetting>("/settings/borrowing_limit_pct", { value })` for updating
    - Define a local type: `type AppSetting = { key: string; value: string }`
    - Extract borrowing_limit_pct from the settings array: `settings.find(s => s.key === "borrowing_limit_pct")?.value ?? "100"`
    - Use two styled buttons (or radio-button-like cards) for the 100%/50% selection -- highlight the active one with `bg-primary text-primary-foreground` (same pattern as Layout.tsx NavLink active state)
    - Include a brief explanation: "Controls the maximum percentage of a contract's annual points that can be borrowed from the next use year."
    - Page title: "Settings" with consistent heading style (`text-2xl font-bold` like other pages)

    **Update `frontend/src/components/Layout.tsx`** -- Add Settings to navigation:
    - Add to the `navItems` array: `{ to: "/settings", label: "Settings" }`
    - Place it LAST in the array (after Point Charts) since it's a utility page, not a core feature.

    **Update `frontend/src/App.tsx`** -- Add Settings route:
    - Add import: `import SettingsPage from "./pages/SettingsPage";`
    - Add route inside the `<Route element={<Layout />}>` group:
      `<Route path="/settings" element={<SettingsPage />} />`
    - Place it after the existing `/point-charts` route.
  </action>
  <verify>
    ```bash
    cd /Users/julianamacbook/dvc/frontend
    npx tsc --noEmit
    npm run build
    ```
    - TypeScript compilation succeeds with no errors
    - Vite build succeeds (produces dist/ output)
    - Manually verify (or in Docker): navigate to /settings, see borrowing policy toggle, click 50%, verify it saves, click 100%, verify it reverts. Then go to Contracts, try adding borrowed points exceeding the limit to confirm enforcement.
  </verify>
  <done>
    - SettingsPage.tsx exists and renders a borrowing policy toggle (100%/50%)
    - Changing the toggle calls PUT /api/settings/borrowing_limit_pct
    - Layout.tsx sidebar includes "Settings" nav link
    - App.tsx has /settings route
    - TypeScript compiles without errors
    - CONF-01 is fully satisfied: borrowing policy is configurable from the UI and reflected in point calculations
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete app settings system with borrowing policy:
    - Backend: AppSetting model, migration, settings API, borrowing enforcement in point creation/update
    - Frontend: Settings page with 100%/50% borrowing policy toggle
    - Integration: Changing the setting immediately affects point balance validation
  </what-built>
  <how-to-verify>
    1. Run `docker compose up --build -d` (rebuilds with new code)
    2. Open http://localhost:8000 in browser
    3. Navigate to "Settings" in the sidebar -- should see borrowing policy toggle
    4. Verify default is 100%
    5. Go to Contracts, create or select a contract (e.g., 200 annual points)
    6. Add a "borrowed" point balance of 150 points -- should succeed (150 <= 200)
    7. Go back to Settings, toggle to 50%
    8. Try to add another borrowed balance of 150 for a different use year -- should be rejected (150 > 100, which is 50% of 200)
    9. Toggle back to 100%, same request should now succeed
    10. Run `docker compose down && docker compose up -d`, wait 10s, verify Settings page still shows the last-saved policy value
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `GET /api/settings` returns `[{"key": "borrowing_limit_pct", "value": "100"}]`
2. `PUT /api/settings/borrowing_limit_pct` with `{"value": "50"}` succeeds
3. `PUT /api/settings/borrowing_limit_pct` with `{"value": "75"}` returns 422 (invalid value)
4. With policy at 50%, creating borrowed points > 50% of annual_points returns 422
5. With policy at 100%, creating borrowed points up to annual_points succeeds
6. Settings page renders in browser with working toggle
7. Settings nav link appears in sidebar
8. Settings survive container restart
</verification>

<success_criteria>
- Borrowing policy toggle (100%/50%) is accessible from the Settings page
- Toggling the policy immediately affects borrowed point validation
- Settings persist in the database (survive container restarts)
- Default on fresh install is 100% (no restriction)
- CONF-01 fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04/04-02-SUMMARY.md`
</output>
