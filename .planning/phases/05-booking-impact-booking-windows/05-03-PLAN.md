---
phase: 05-booking-impact-booking-windows
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - backend/api/booking_windows.py
  - backend/api/schemas.py
  - backend/main.py
  - frontend/src/hooks/useBookingWindows.ts
  - frontend/src/components/UrgentAlerts.tsx
  - frontend/src/pages/DashboardPage.tsx
  - frontend/src/types/index.ts
  - tests/test_api_booking_windows.py
autonomous: true

must_haves:
  truths:
    - "Dashboard shows upcoming booking window openings in the alerts section"
    - "Only windows opening within the next 30 days that have NOT yet opened are shown"
    - "Alerts show contract name, resort, check-in date, window type, and opening date"
    - "Alerts are capped at 5 to prevent overload"
  artifacts:
    - path: "backend/api/booking_windows.py"
      provides: "GET /api/booking-windows/upcoming endpoint"
      exports: ["router"]
    - path: "frontend/src/hooks/useBookingWindows.ts"
      provides: "React Query hook for upcoming booking window alerts"
      exports: ["useUpcomingBookingWindows"]
    - path: "frontend/src/components/UrgentAlerts.tsx"
      provides: "Extended alert component with booking window alert type"
    - path: "tests/test_api_booking_windows.py"
      provides: "Integration tests for booking windows endpoint"
  key_links:
    - from: "frontend/src/pages/DashboardPage.tsx"
      to: "frontend/src/hooks/useBookingWindows.ts"
      via: "useUpcomingBookingWindows() hook call"
      pattern: "useUpcomingBookingWindows"
    - from: "frontend/src/components/UrgentAlerts.tsx"
      to: "frontend/src/types/index.ts"
      via: "BookingWindowAlert type"
      pattern: "BookingWindowAlert"
    - from: "frontend/src/hooks/useBookingWindows.ts"
      to: "/api/booking-windows/upcoming"
      via: "api.get() call"
      pattern: "booking-windows/upcoming"
    - from: "backend/api/booking_windows.py"
      to: "backend/engine/booking_windows.py"
      via: "calls compute_booking_windows() for each reservation"
      pattern: "compute_booking_windows"
---

<objective>
Add dashboard alerts for upcoming booking window openings and a supporting backend endpoint.

Purpose: Fulfills BKWN-04 -- the user sees upcoming booking window openings on the dashboard alerts section, so they know when to act on reservations they're planning.

Output: New backend endpoint GET /api/booking-windows/upcoming, updated UrgentAlerts component with booking window alert type, and updated DashboardPage to fetch and display these alerts.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-booking-impact-booking-windows/05-RESEARCH.md
@.planning/phases/05-booking-impact-booking-windows/05-01-SUMMARY.md
@backend/engine/booking_windows.py
@backend/api/availability.py
@backend/main.py
@frontend/src/components/UrgentAlerts.tsx
@frontend/src/pages/DashboardPage.tsx
@frontend/src/hooks/useReservations.ts
@frontend/src/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backend booking windows upcoming endpoint with tests</name>
  <files>
    backend/api/booking_windows.py
    backend/api/schemas.py
    backend/main.py
    tests/test_api_booking_windows.py
  </files>
  <action>
**backend/api/booking_windows.py (NEW):**
Create a new API module with a router.

```python
GET /api/booking-windows/upcoming
```

Query param: `days: int = Query(30, ge=1, le=90)` -- look-ahead window in days.

Endpoint logic:
1. Load all contracts from DB.
2. Load all non-cancelled reservations with `check_in >= date.today()` (future only).
3. For each reservation, load its contract to determine `home_resort`.
4. For each reservation, call `compute_booking_windows(reservation.check_in, is_home_resort=(contract.home_resort == reservation.resort))`.
5. Build alert objects. For each reservation, check both window types:
   - Home resort window (11-month): include if `not window_data["home_resort_window_open"]` AND `0 < window_data["days_until_home_window"] <= days` AND `window_data["is_home_resort"]` is True.
   - Any resort window (7-month): include if `not window_data["any_resort_window_open"]` AND `0 < window_data["days_until_any_window"] <= days`.
6. Each alert dict: `contract_name` (str), `resort` (str, the reservation's resort slug), `resort_name` (str, from resorts data), `check_in` (ISO date string), `window_type` ("home_resort" or "any_resort"), `window_date` (ISO date string), `days_until_open` (int).
7. Sort by `days_until_open` ascending (soonest first).
8. Cap at 5 results (slice [:5]).
9. Return list of alert dicts.

Import `compute_booking_windows` from `backend.engine.booking_windows`. Import Contract, Reservation from models. Import `load_resorts` from `backend.data.resorts` for resort name lookup. Use the same ORM-to-dict pattern as availability.py.

**backend/api/schemas.py -- add:**
```python
class BookingWindowAlert(BaseModel):
    contract_name: str
    resort: str
    resort_name: str
    check_in: str
    window_type: str  # "home_resort" or "any_resort"
    window_date: str
    days_until_open: int
```

**backend/main.py:**
Import and register the new router:
```python
from backend.api.booking_windows import router as booking_windows_router
# Add BEFORE SPA mount, AFTER other routers:
app.include_router(booking_windows_router)
```

**tests/test_api_booking_windows.py (NEW):**
Test the endpoint:
- GET /api/booking-windows/upcoming with no reservations returns empty list.
- Create a contract and a reservation with check_in ~8 months from now (so the 7-month window opens in ~1 month), verify the endpoint returns an alert for the any-resort window.
- Create a reservation at the contract's home resort with check_in ~12 months from now (so 11-month window opens in ~1 month), verify home_resort window alert appears.
- Verify alerts are sorted by days_until_open ascending.
- Verify cap at 5 (create 6+ eligible reservations, confirm only 5 returned).
  </action>
  <verify>
Run: `cd /Users/julianamacbook/DVC && python -m pytest tests/test_api_booking_windows.py -v`
All tests pass.
Run: `cd /Users/julianamacbook/DVC && python -m pytest tests/ -v --tb=short`
Full test suite passes (no regressions).
  </verify>
  <done>
GET /api/booking-windows/upcoming endpoint works. Returns up to 5 upcoming booking window alerts sorted by soonest opening. Filters to windows not yet open and within the look-ahead period. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Dashboard booking window alerts in UrgentAlerts component</name>
  <files>
    frontend/src/types/index.ts
    frontend/src/hooks/useBookingWindows.ts
    frontend/src/components/UrgentAlerts.tsx
    frontend/src/pages/DashboardPage.tsx
  </files>
  <action>
**frontend/src/types/index.ts -- add (if not already added by Plan 02):**
```typescript
// Dashboard Booking Window Alert type
export interface BookingWindowAlert {
  contract_name: string;
  resort: string;
  resort_name: string;
  check_in: string;
  window_type: "home_resort" | "any_resort";
  window_date: string;
  days_until_open: number;
}
```

**frontend/src/hooks/useBookingWindows.ts (NEW):**
```typescript
import { useQuery } from "@tanstack/react-query";
import { api } from "../lib/api";
import type { BookingWindowAlert } from "../types";

export function useUpcomingBookingWindows() {
  return useQuery({
    queryKey: ["booking-windows", "upcoming"],
    queryFn: () => api.get<BookingWindowAlert[]>("/booking-windows/upcoming"),
  });
}
```

**frontend/src/components/UrgentAlerts.tsx:**
Extend to accept an optional `bookingWindowAlerts` prop alongside existing `items` prop.

Updated props:
```typescript
interface UrgentAlertsProps {
  items: AvailabilityContractResult[];
  bookingWindowAlerts?: BookingWindowAlert[];
}
```

Add new imports: `CalendarCheckIcon` and `CalendarClockIcon` from lucide-react. Import `format`, `parseISO` from date-fns. Import `BookingWindowAlert` from types.

After the existing banking deadline and point expiration alerts in the `<ul>`, add booking window alerts:
```tsx
{bookingWindowAlerts?.map((alert, idx) => (
  <li
    key={`bw-${alert.window_type}-${alert.resort}-${idx}`}
    className="flex items-start gap-2 text-sm text-blue-700"
  >
    {alert.window_type === "home_resort" ? (
      <CalendarCheckIcon className="size-4 mt-0.5 shrink-0" />
    ) : (
      <CalendarClockIcon className="size-4 mt-0.5 shrink-0" />
    )}
    <span>
      {alert.contract_name} @ {alert.resort_name}:{" "}
      {alert.window_type === "home_resort" ? "11-month" : "7-month"} window
      opens in {alert.days_until_open} day{alert.days_until_open !== 1 ? "s" : ""}{" "}
      ({format(parseISO(alert.window_date), "MMM d")})
      {" -- "}check-in {format(parseISO(alert.check_in), "MMM d, yyyy")}
    </span>
  </li>
))}
```

Use blue styling for booking window alerts (distinct from amber banking and red expiration).

Update the visibility logic: The card should show if there are ANY alerts (existing urgent items OR booking window alerts). Currently the parent conditionally renders `{urgentItems.length > 0 && <UrgentAlerts ...>}`. The parent (DashboardPage) will handle this -- see below.

**frontend/src/pages/DashboardPage.tsx:**
Import `useUpcomingBookingWindows` from hooks. Add the hook call inside the component:
```typescript
const { data: bookingWindowAlerts } = useUpcomingBookingWindows();
```

Update the `isLoading` check if desired (booking window alerts can load independently -- they're supplementary, not blocking).

Update the conditional rendering of UrgentAlerts to also show when booking window alerts exist:
```tsx
{(urgentItems.length > 0 || (bookingWindowAlerts && bookingWindowAlerts.length > 0)) && (
  <UrgentAlerts items={urgentItems} bookingWindowAlerts={bookingWindowAlerts} />
)}
```

Pass `bookingWindowAlerts={bookingWindowAlerts ?? []}` to the component.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/DVC/frontend && npx tsc --noEmit`
Zero TypeScript errors.
Run: `cd /Users/julianamacbook/DVC/frontend && npx vite build`
Build succeeds.
  </verify>
  <done>
Dashboard shows booking window alerts in the UrgentAlerts section. Alerts display contract name, resort, window type (11-month/7-month), days until opening, opening date, and associated check-in date. Blue styling distinguishes them from banking (amber) and expiration (red) alerts. TypeScript and Vite build pass.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd frontend && npx tsc --noEmit` -- zero errors
2. Vite production build: `cd frontend && npx vite build` -- succeeds
3. Backend tests: `python -m pytest tests/ -v --tb=short` -- all pass
4. GET /api/booking-windows/upcoming returns alerts for reservations with upcoming windows
5. Dashboard shows blue booking window alerts alongside existing amber/red alerts
6. Alerts are capped at 5 and sorted by soonest opening
</verification>

<success_criteria>
- GET /api/booking-windows/upcoming endpoint returns correctly filtered and sorted alerts
- Dashboard UrgentAlerts section shows booking window alerts with blue styling
- Only windows opening within 30 days (default) that haven't opened yet are shown
- Alerts capped at 5
- All backend tests pass including new booking_windows tests
- Frontend builds clean
</success_criteria>

<output>
After completion, create `.planning/phases/05-booking-impact-booking-windows/05-03-SUMMARY.md`
</output>
