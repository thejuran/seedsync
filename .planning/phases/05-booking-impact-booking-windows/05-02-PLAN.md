---
phase: 05-booking-impact-booking-windows
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - frontend/src/types/index.ts
  - frontend/src/hooks/useBookingPreview.ts
  - frontend/src/components/BookingImpactPanel.tsx
  - frontend/src/components/BookingWindowBadges.tsx
  - frontend/src/components/TripExplorerResults.tsx
  - frontend/src/pages/TripExplorerPage.tsx
autonomous: true

must_haves:
  truths:
    - "User can expand any Trip Explorer result card to see booking impact details"
    - "Expanded card shows before/after point balance per contract"
    - "Expanded card shows nightly point breakdown"
    - "Expanded card shows banking warning when applicable"
    - "Expanded card shows 11-month and 7-month booking window dates"
    - "Preview data loads lazily only when card is expanded"
  artifacts:
    - path: "frontend/src/hooks/useBookingPreview.ts"
      provides: "React Query hook for lazy-loaded preview API call"
      exports: ["useBookingPreview"]
    - path: "frontend/src/components/BookingImpactPanel.tsx"
      provides: "Before/after point balance display with banking warning"
      exports: ["default"]
    - path: "frontend/src/components/BookingWindowBadges.tsx"
      provides: "11-month and 7-month window date badges"
      exports: ["default"]
    - path: "frontend/src/components/TripExplorerResults.tsx"
      provides: "Expandable result cards with impact + windows"
    - path: "frontend/src/types/index.ts"
      provides: "ReservationPreview, BookingWindowInfo, BankingWarning, AvailabilitySnapshot types"
  key_links:
    - from: "frontend/src/hooks/useBookingPreview.ts"
      to: "/api/reservations/preview"
      via: "api.post() call with contract_id, resort, room_key, check_in, check_out"
      pattern: "api\\.post.*reservations/preview"
    - from: "frontend/src/components/TripExplorerResults.tsx"
      to: "frontend/src/hooks/useBookingPreview.ts"
      via: "useBookingPreview(isExpanded ? request : null)"
      pattern: "useBookingPreview"
    - from: "frontend/src/components/TripExplorerResults.tsx"
      to: "frontend/src/components/BookingImpactPanel.tsx"
      via: "renders inside expanded card section"
      pattern: "BookingImpactPanel"
    - from: "frontend/src/components/TripExplorerResults.tsx"
      to: "frontend/src/components/BookingWindowBadges.tsx"
      via: "renders inside expanded card section"
      pattern: "BookingWindowBadges"
---

<objective>
Add expandable Trip Explorer result cards that show booking impact preview (before/after point balances, nightly breakdown, banking warning) and booking window dates (11-month home resort, 7-month any resort).

Purpose: Fulfills IMPT-01 through IMPT-04 and BKWN-01 through BKWN-03 -- the user can see how a potential booking affects their points and when windows open, all inline from Trip Explorer results.

Output: Updated TripExplorerResults with expandable cards, new BookingImpactPanel and BookingWindowBadges components, useBookingPreview hook, and updated TypeScript types.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-booking-impact-booking-windows/05-RESEARCH.md
@.planning/phases/05-booking-impact-booking-windows/05-01-SUMMARY.md
@frontend/src/types/index.ts
@frontend/src/components/TripExplorerResults.tsx
@frontend/src/pages/TripExplorerPage.tsx
@frontend/src/hooks/useTripExplorer.ts
@frontend/src/lib/api.ts
@frontend/src/lib/utils.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types + preview hook</name>
  <files>
    frontend/src/types/index.ts
    frontend/src/hooks/useBookingPreview.ts
  </files>
  <action>
**frontend/src/types/index.ts -- add these types at the end (after Trip Explorer types):**

```typescript
// Booking Impact Preview types

export interface BookingWindowInfo {
  home_resort_window: string;
  home_resort_window_open: boolean;
  days_until_home_window: number;
  any_resort_window: string;
  any_resort_window_open: boolean;
  days_until_any_window: number;
  is_home_resort: boolean;
}

export interface BankingWarning {
  warning: boolean;
  bankable_points: number;
  banking_deadline: string;
  days_until_deadline: number;
  message: string;
}

export interface AvailabilitySnapshot {
  total_points: number;
  committed_points: number;
  available_points: number;
  balances: Record<string, number>;
}

export interface ReservationPreview {
  before: AvailabilitySnapshot;
  after: AvailabilitySnapshot;
  points_delta: number;
  nightly_breakdown: NightlyCost[];
  total_points: number;
  num_nights: number;
  booking_windows: BookingWindowInfo;
  banking_warning: BankingWarning | null;
}
```

**frontend/src/hooks/useBookingPreview.ts:**

```typescript
import { useQuery } from "@tanstack/react-query";
import { api } from "../lib/api";
import type { ReservationPreview } from "../types";

interface PreviewRequest {
  contract_id: number;
  resort: string;
  room_key: string;
  check_in: string;
  check_out: string;
}

export function useBookingPreview(request: PreviewRequest | null) {
  return useQuery({
    queryKey: ["booking-preview", request?.contract_id, request?.resort, request?.room_key, request?.check_in],
    queryFn: () => api.post<ReservationPreview>("/reservations/preview", request),
    enabled: !!request,
    staleTime: 30_000,
  });
}
```

Key details:
- `queryKey` includes contract_id + resort + room_key + check_in so each card has its own cache entry (prevents stale data in wrong card, per Research pitfall 3).
- `enabled: !!request` means the query only fires when request is non-null (when card is expanded).
- `staleTime: 30_000` prevents re-fetching on rapid expand/collapse cycles.
- Uses `api.post` (not `api.get`) because the preview endpoint is POST.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/DVC/frontend && npx tsc --noEmit`
Zero TypeScript errors.
  </verify>
  <done>
All preview-related types defined. Hook created with lazy-loading via `enabled` flag and unique queryKey per card.
  </done>
</task>

<task type="auto">
  <name>Task 2: BookingImpactPanel, BookingWindowBadges, and expandable TripExplorerResults</name>
  <files>
    frontend/src/components/BookingImpactPanel.tsx
    frontend/src/components/BookingWindowBadges.tsx
    frontend/src/components/TripExplorerResults.tsx
    frontend/src/pages/TripExplorerPage.tsx
  </files>
  <action>
**frontend/src/components/BookingImpactPanel.tsx:**
Create a component that displays the booking impact preview data. Props: `preview: ReservationPreview`.

Layout:
1. **Before/After section** -- Two-column layout (grid grid-cols-2 gap-4). Left column "Before" shows `preview.before.available_points` pts available with breakdown by allocation type (iterate `preview.before.balances`, display each as "{type}: {points} pts" using ALLOCATION_TYPE_LABELS from types). Right column "After" shows same for `preview.after`. Use muted text for labels, bold for point numbers. Show the delta prominently: "-{preview.points_delta} pts" in red/destructive color between or below the columns.
2. **Nightly breakdown** -- Collapsible table (simple `<details><summary>` element -- no extra deps needed). Summary text: "{preview.num_nights} nights, {preview.total_points} pts total". Inside: a small table with columns Date, Day, Season, Points. Each row from `preview.nightly_breakdown`. Weekend rows get subtle background highlight (bg-muted/30).
3. **Banking warning** -- Only shown if `preview.banking_warning` is not null. Yellow/amber alert box (matching UrgentAlerts pattern): AlertTriangle icon + `preview.banking_warning.message`.

Import from types: `ReservationPreview`, `ALLOCATION_TYPE_LABELS`. Import from lucide-react: `AlertTriangleIcon`. Use Tailwind classes consistent with existing components.

**frontend/src/components/BookingWindowBadges.tsx:**
Create a component showing booking window dates. Props: `windows: BookingWindowInfo`.

Layout: Two Badge components side by side (flex gap-2 flex-wrap).
- If `windows.is_home_resort`: Show "11-mo Home: {formatted date}" badge. If window is open: green variant (`bg-green-100 text-green-800`), text "11-mo Home: Open". If not open: blue variant (`bg-blue-100 text-blue-800`), text "11-mo Home: Opens {date}" with `format(parseISO(windows.home_resort_window), "MMM d, yyyy")` from date-fns.
- Always show "7-mo Any Resort: {formatted date}" badge. Same color logic: green if open, blue if not yet. Text: "7-mo: Open" or "7-mo: Opens {date}".
- If a window opens within 14 days and is not yet open, add pulsing ring or slightly stronger styling to draw attention (use `ring-2 ring-blue-300 animate-pulse` or similar subtle indicator).

Import from date-fns: `format`, `parseISO`. Import Badge from ui/badge.

**frontend/src/components/TripExplorerResults.tsx:**
Major refactor to support expandable cards. The component currently receives `data: TripExplorerResponse`. It needs check_in and check_out strings from the parent to pass to the preview hook.

Change the props interface:
```typescript
interface TripExplorerResultsProps {
  data: TripExplorerResponse;
  checkIn: string;
  checkOut: string;
}
```

Extract each result card into an internal `TripExplorerResultCard` component (defined in the same file, not exported) that manages its own expanded state:

```typescript
function TripExplorerResultCard({ option, checkIn, checkOut }: {
  option: TripExplorerOption;
  checkIn: string;
  checkOut: string;
}) {
  const [isExpanded, setIsExpanded] = useState(false);
  const { data: preview, isLoading } = useBookingPreview(
    isExpanded ? {
      contract_id: option.contract_id,
      resort: option.resort,
      room_key: option.room_key,
      check_in: checkIn,
      check_out: checkOut,
    } : null
  );
  // ... card rendering with expand/collapse
}
```

Card rendering changes:
- Add `cursor-pointer` to the Card. On click of CardContent (or a chevron button), toggle `isExpanded`.
- Add a ChevronDown icon (from lucide-react) at the top-right of the card. Rotate 180 degrees when expanded (`transition-transform duration-200`).
- When expanded, render a `<div className="border-t px-4 py-3 space-y-4">` below CardContent containing:
  - If `isLoading`: Show a simple "Loading preview..." text with muted styling.
  - If `preview`: Render `<BookingImpactPanel preview={preview} />` then `<BookingWindowBadges windows={preview.booking_windows} />`.

The parent grid stays the same (grid gap-3 sm:grid-cols-1 md:grid-cols-2 lg:grid-cols-3) but each card is now the internal component.

**frontend/src/pages/TripExplorerPage.tsx:**
Pass `checkIn` and `checkOut` as props to TripExplorerResults:
```tsx
{data && <TripExplorerResults data={data} checkIn={checkIn} checkOut={checkOut} />}
```

No other changes to TripExplorerPage.
  </action>
  <verify>
Run: `cd /Users/julianamacbook/DVC/frontend && npx tsc --noEmit`
Zero TypeScript errors.
Run: `cd /Users/julianamacbook/DVC/frontend && npx vite build`
Build succeeds with no errors.
  </verify>
  <done>
Trip Explorer result cards are expandable. Each expanded card shows before/after point balances with allocation breakdown, nightly cost breakdown (collapsible table), banking warning (when applicable), and booking window date badges with open/upcoming status. Preview data loads lazily only when a card is expanded. TypeScript compiles clean. Vite build succeeds.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `cd frontend && npx tsc --noEmit` -- zero errors
2. Vite production build: `cd frontend && npx vite build` -- succeeds
3. Manual verification: Start dev server, go to Trip Explorer, enter dates, click a result card -- should expand showing impact panel with before/after balances, nightly breakdown, and booking window badges
4. Lazy loading: Opening Network tab shows POST /api/reservations/preview fires only when expanding a card, not on initial search
5. Multiple cards: Expanding different cards shows correct data per card (no cross-contamination)
</verification>

<success_criteria>
- Trip Explorer result cards expand/collapse on click
- Expanded card shows before/after point balances with allocation breakdown
- Expanded card shows nightly point breakdown in collapsible table
- Banking warning appears (amber box) when proposed booking consumes bankable points
- Booking window badges show correct dates with open/upcoming status
- Preview API call is lazy-loaded (only fires on expand)
- TypeScript and Vite build pass clean
</success_criteria>

<output>
After completion, create `.planning/phases/05-booking-impact-booking-windows/05-02-SUMMARY.md`
</output>
